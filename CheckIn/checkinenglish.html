<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check In • Barbie's Bail Bonds</title>
  <style>
    :root {
      --brand: #F28C00;
      --brand-dark: #D67700;
      --dark: #111;
      --muted: #666;
      --light-gray: #eee;
      --white: #fff;
      --cream: #fff2d1;
      --black: #000;
      --success: #28a745;
      --error: #dc3545;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.6;
      color: var(--white);
      background: #000;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container { width: 100%; max-width: 1200px; margin: 0 auto; padding: 40px 20px; }
    .header { text-align: center; margin-bottom: 30px; }
    .title { font-size: 38px; font-weight: 800; margin-bottom: 10px; }
    .subtitle { font-size: 18px; opacity: 0.9; }

    .help-banner {
      background: var(--cream);
      color: var(--black);
      padding: 30px 24px;
      border-radius: 12px;
      margin: 24px 0 34px;
      box-shadow: 0 8px 24px rgba(255, 242, 209, 0.2);
      text-align: center;
    }
    .help-banner .phone { font-size: 28px; font-weight: 800; letter-spacing: .5px; }
    .help-banner .phone a { color: var(--brand); text-decoration: none; white-space: nowrap; }
    .help-banner .phone a:hover { color: var(--brand-dark); }

    .card {
      background: var(--white);
      color: var(--dark);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 6px 20px rgba(0,0,0,.15);
      margin-bottom: 20px;
    }
    .section-title { font-size: 20px; font-weight: 700; margin-bottom: 14px; }

    label { display: block; font-weight: 600; font-size: 14px; margin-bottom: 6px; }
    input[type="text"] {
      width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background:#fff; color:#111;
      min-height: 48px;
    }

    .btn {
      background: var(--brand);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 1.1rem;
      cursor: pointer;
      margin: 10px;
      transition: background-color 0.3s;
    }

    .btn:hover {
      background: var(--brand-dark);
    }

    .btn:disabled {
      background: #666;
      cursor: not-allowed;
    }

    .btn-ghost {
      background: #eee;
      color: #111;
    }

    .success {
      background: #1a5d1a;
      color: #90EE90;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      display: none;
    }

    .error {
      background: #5d1a1a;
      color: #ffcccb;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      display: none;
    }

    .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 18px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">Check In</div>
      <div class="subtitle">Take a photo to check in with your bond requirements.</div>
    </div>

    <div class="help-banner">
      <div class="phone">Need help? Call us 24/7 at <a href="tel:561-247-0018">561-247-0018</a></div>
    </div>

    <div class="checkin-form card">
      <div class="section-title">Check In</div>
      <div class="instructions" style="margin-bottom: 30px; text-align: center; color: #666;">
        This check-in requires photo verification for compliance with your bond requirements.
      </div>

      <div style="margin-bottom: 30px;">
        <label for="fullName" style="display: block; font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #333;">Your Full Name<span style="color:#dc3545">*</span></label>
        <input id="fullName" type="text" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; background:#fff; color:#111; min-height: 48px;" />
      </div>

      <div class="camera-section" style="background: #f8f9fa; border-radius: 12px; padding: 30px; margin-bottom: 30px; border: 2px dashed #ddd; text-align: center;">
        <video id="video" style="width: 100%; max-width: 300px; border-radius: 8px; margin-bottom: 20px; display: none;"></video>
        <canvas id="canvas" style="display: none;"></canvas>
        <img id="photoPreview" style="width: 100%; max-width: 300px; border-radius: 8px; margin: 20px auto; display: none;" alt="Photo preview">

        <div id="cameraControls">
          <button type="button" id="startCamera" class="btn">Start Camera</button>
          <button type="button" id="takePhoto" class="btn" style="display: none;">Take Photo</button>
          <button type="button" id="retakePhoto" class="btn btn-ghost" style="display: none;">Retake Photo</button>
        </div>
      </div>

      <div class="actions">
        <button type="button" id="submitCheckin" class="btn" style="display: none;">Submit Check-In</button>
      </div>

      <div class="success" id="successMsg">✅ Check-in successful! Your photo has been recorded.</div>
      <div class="error" id="errorMsg">❌ Check-in failed. Please try again or call us at <span style="white-space: nowrap;">561-247-0018</span>.</div>
    </div>

  </div>

  <script>
    let photoTaken = false;
    let locationData = null;
    let stream = null;

    document.addEventListener('DOMContentLoaded', function() {
      setupCheckinEvents();
      getLocation();
    });

    function setupCheckinEvents() {
      const startBtn = document.getElementById('startCamera');
      const takeBtn = document.getElementById('takePhoto');
      const retakeBtn = document.getElementById('retakePhoto');
      const submitBtn = document.getElementById('submitCheckin');
      const nameField = document.getElementById('fullName');

      startBtn.addEventListener('click', startCamera);
      takeBtn.addEventListener('click', takePhoto);
      retakeBtn.addEventListener('click', retakePhoto);
      submitBtn.addEventListener('click', submitCheckin);

      nameField.addEventListener('input', checkSubmitReady);
      nameField.addEventListener('blur', checkSubmitReady);
    }

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'user',
            width: { ideal: 640 },
            height: { ideal: 480 }
          },
          audio: false
        });

        const video = document.getElementById('video');
        video.srcObject = stream;
        video.style.display = 'block';

        document.getElementById('startCamera').style.display = 'none';
        document.getElementById('takePhoto').style.display = 'inline-block';
      } catch (error) {
        console.error('Camera error:', error);
        showStatus('Camera access denied. Please allow camera access and try again.', 'error');
      }
    }

    function takePhoto() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);

      const photoData = canvas.toDataURL('image/jpeg', 0.8);
      const preview = document.getElementById('photoPreview');

      preview.src = photoData;
      preview.style.display = 'block';

      video.style.display = 'none';
      document.getElementById('takePhoto').style.display = 'none';
      document.getElementById('retakePhoto').style.display = 'inline-block';

      photoTaken = true;
      checkSubmitReady();

      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
    }

    function retakePhoto() {
      document.getElementById('photoPreview').style.display = 'none';
      document.getElementById('retakePhoto').style.display = 'none';

      photoTaken = false;
      checkSubmitReady();

      startCamera();
    }

    function getLocation() {
      if (!navigator.geolocation) {
        getIPLocation();
        return;
      }

      navigator.geolocation.getCurrentPosition(
        function(position) {
          locationData = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy,
            timestamp: new Date().toISOString(),
            source: 'GPS'
          };

          console.log('GPS Location:', position.coords.latitude, position.coords.longitude, position.coords.accuracy);
          checkSubmitReady();
        },
        function(error) {
          console.log('GPS location failed, falling back to IP location');
          getIPLocation();
        },
        {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 300000
        }
      );
    }

    function getIPLocation() {
      try {
        fetch('https://ipapi.co/json/')
          .then(response => response.json())
          .then(data => {
            if (data.latitude && data.longitude) {
              locationData = {
                latitude: data.latitude,
                longitude: data.longitude,
                accuracy: 10000,
                timestamp: new Date().toISOString(),
                source: 'IP',
                city: data.city,
                region: data.region,
                country: data.country_name
              };

              console.log('IP Location:', data.city, data.region, data.latitude, data.longitude);
              checkSubmitReady();
            } else {
              throw new Error('No location data received');
            }
          })
          .catch(error => {
            console.error('IP location failed:', error);
            showStatus('Unable to determine location. Please ensure you have an internet connection.', 'error');
          });
      } catch (error) {
        showStatus('Location services unavailable. Please try again later.', 'error');
      }
    }

    function checkSubmitReady() {
      const nameField = document.getElementById('fullName');
      const hasName = nameField && nameField.value.trim() !== '';

      if (photoTaken && locationData && hasName) {
        document.getElementById('submitCheckin').style.display = 'inline-block';
      } else {
        document.getElementById('submitCheckin').style.display = 'none';
      }
    }

    async function submitCheckin() {
      const submitBtn = document.getElementById('submitCheckin');

      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        const canvas = document.getElementById('canvas');
        const fullName = document.getElementById('fullName').value.trim();

        const checkinData = {
          fullName: fullName,
          photo: canvas.toDataURL('image/jpeg', 0.8),
          location: locationData,
          timestamp: new Date().toISOString(),
          userAgent: navigator.userAgent,
          language: 'en'
        };

        console.log('Check-in data:', checkinData);

        const response = await fetch('https://script.google.com/macros/s/AKfycbzssXFlfnGJFa94I9b4qdz_kw09Q8ADADEUc8jvotBPTK07h_BSpb3QERkM-StX7yJJ/exec', {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(checkinData)
        });

        console.log('Check-in submitted to server');

        showStatus('✅ Check-in successful! Your photo has been recorded.', 'success');

        setTimeout(() => {
          location.reload();
        }, 3000);

      } catch (error) {
        console.error('Error submitting check-in:', error);
        showStatus('❌ Check-in failed. Please try again or call us directly.', 'error');

        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Check-In';
      }
    }

    function showStatus(message, type) {
      const statusEl = document.getElementById(type === 'success' ? 'successMsg' : 'errorMsg');
      statusEl.textContent = message;
      statusEl.style.display = 'block';

      const otherType = type === 'success' ? 'errorMsg' : 'successMsg';
      const otherEl = document.getElementById(otherType);
      if (otherEl) otherEl.style.display = 'none';

      statusEl.scrollIntoView({ behavior: 'smooth' });
    }
  </script>
</body>
</html>