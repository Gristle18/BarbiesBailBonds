<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Search ‚Ä¢ Barbie's Bail Bonds</title>
  <style>
    :root {
      --brand: #F28C00;
      --brand-dark: #D67700;
      --dark: #111;
      --muted: #666;
      --light-gray: #eee;
      --white: #fff;
      --cream: #fff2d1;
      --black: #000;
      --success: #28a745;
      --error: #dc3545;
      --blue: #007bff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.6;
      color: var(--dark);
      background: var(--light-gray);
      min-height: 100vh;
      overflow-x: hidden; /* Hide horizontal scrollbar */
    }

    /* Hide scrollbars for webkit browsers */
    ::-webkit-scrollbar {
      display: none;
    }

    /* Hide scrollbars for Firefox */
    html {
      scrollbar-width: none;
    }

    /* Remove focus outline and prevent text editing cursor */
    * { outline: none; }
    a, button, .btn { cursor: pointer; }

    .container { 
      width: 100%; 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 20px; 
    }

    .header { 
      text-align: center; 
      margin-bottom: 30px; 
      background: var(--white);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .title { 
      font-size: 32px; 
      font-weight: 700; 
      margin-bottom: 8px; 
      color: var(--dark);
    }
    
    .subtitle { 
      font-size: 16px; 
      color: var(--muted); 
    }

    .search-section {
      background: var(--white);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .advanced-search {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      margin-top: 20px;
    }

    .advanced-header {
      text-align: center;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 15px;
      margin-bottom: 25px;
    }

    .field-search-container {
      max-width: 900px;
      margin: 0 auto;
    }

    .field-search-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .field-input-group {
      display: flex;
      flex-direction: column;
    }

    .field-input-group label {
      font-size: 14px;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .field-input-group input {
      padding: 12px 16px;
      font-size: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: var(--white);
      color: var(--dark);
      transition: all 0.3s ease;
    }

    .field-input-group input:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(242, 140, 0, 0.1);
      outline: none;
    }

    .field-input-group input::placeholder {
      color: var(--muted);
      font-style: italic;
    }

    .field-search-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .search-button-main {
      background: var(--brand);
      color: var(--white);
      border: none;
      border-radius: 8px;
      padding: 15px 40px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .search-button-main:hover:not(:disabled) {
      background: var(--brand-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(242, 140, 0, 0.3);
    }

    .search-button-main:disabled {
      background: var(--muted);
      cursor: not-allowed;
      transform: none;
    }

    .clear-button {
      background: var(--muted);
      color: var(--white);
      border: none;
      border-radius: 8px;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .clear-button:hover {
      background: var(--dark);
      transform: translateY(-2px);
    }

    .search-container {
      position: relative;
      max-width: 800px;
      margin: 0 auto;
    }

    .search-input {
      width: 100%;
      padding: 16px 60px 16px 20px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 50px;
      background: var(--white);
      color: var(--dark);
      transition: all 0.3s ease;
    }

    .search-input:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(242, 140, 0, 0.1);
    }

    .search-input::placeholder {
      color: var(--muted);
      font-style: italic;
    }

    .search-button {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--brand);
      color: var(--white);
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .search-button:hover:not(:disabled) {
      background: var(--brand-dark);
      transform: translateY(-50%) scale(1.05);
    }

    .search-button:disabled {
      background: var(--muted);
      cursor: not-allowed;
      transform: translateY(-50%);
    }

    .search-help {
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
      color: var(--muted);
    }

    .search-examples {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    .example-tag {
      background: var(--cream);
      color: var(--dark);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .example-tag:hover {
      background: var(--brand);
      color: var(--white);
    }

    .date-filter-section {
      margin-top: 25px;
      padding: 20px;
      background: var(--cream);
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    .date-filter-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 15px;
      text-align: center;
    }

    .date-row {
      display: flex;
      gap: 30px;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .date-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: 200px;
    }

    .date-group-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--dark);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .date-selectors {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .date-select {
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      background: var(--white);
      color: var(--dark);
      transition: all 0.2s ease;
      cursor: pointer;
      min-width: 60px;
    }

    .date-select:focus {
      border-color: var(--brand);
      outline: none;
      box-shadow: 0 0 0 2px rgba(242, 140, 0, 0.1);
    }

    .date-select:hover {
      border-color: var(--brand-dark);
    }

    .date-filter-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 15px;
    }

    .date-clear-btn, .date-preset-btn {
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .date-clear-btn {
      background: var(--muted);
      color: var(--white);
    }

    .date-clear-btn:hover {
      background: var(--dark);
      transform: translateY(-1px);
    }

    .date-preset-btn {
      background: var(--brand);
      color: var(--white);
    }

    .date-preset-btn:hover {
      background: var(--brand-dark);
      transform: translateY(-1px);
    }

    .date-filter-help {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      margin-top: 10px;
      font-style: italic;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
      display: none;
    }

    .loading.show {
      display: block;
    }

    .loading-spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid var(--light-gray);
      border-top: 3px solid var(--brand);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .results-section {
      display: none;
    }

    .results-section.show {
      display: block;
    }

    .results-header {
      background: var(--white);
      padding: 20px 30px;
      border-radius: 12px 12px 0 0;
      border-bottom: 1px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .results-count {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
    }

    .results-query {
      font-size: 14px;
      color: var(--muted);
      margin-top: 5px;
    }

    .results-list {
      background: var(--white);
      border-radius: 0 0 12px 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .result-item {
      padding: 20px 30px;
      border-bottom: 1px solid var(--light-gray);
      transition: background 0.2s ease;
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-item:hover {
      background: #f8f9fa;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .result-client {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 5px;
    }

    .result-score {
      background: var(--success);
      color: var(--white);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .result-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .result-field {
      display: flex;
      flex-direction: column;
    }

    .result-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 3px;
    }

    .result-value {
      font-size: 14px;
      color: var(--dark);
    }

    .result-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 15px;
      border-top: 1px solid var(--light-gray);
    }

    .result-source {
      font-size: 12px;
      color: var(--muted);
      background: var(--light-gray);
      padding: 4px 8px;
      border-radius: 8px;
    }

    .result-files {
      display: flex;
      gap: 8px;
    }

    .file-link {
      background: var(--blue);
      color: var(--white);
      padding: 6px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .file-link:hover {
      background: #0056b3;
      transform: translateY(-1px);
    }

    .result-dropdown {
      margin-top: 15px;
      border-top: 1px solid var(--light-gray);
      padding-top: 15px;
    }

    .result-dropdown-toggle {
      background: none;
      border: none;
      color: var(--brand);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 8px 12px;
      border-radius: 6px;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .result-dropdown-toggle:hover {
      background: #f8f9fa;
      color: var(--brand-dark);
    }

    .result-dropdown-icon {
      transition: transform 0.2s ease;
      font-size: 12px;
    }

    .result-dropdown-toggle.expanded .result-dropdown-icon {
      transform: rotate(180deg);
    }

    .result-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .result-print-button {
      background: var(--blue);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .result-print-button:hover {
      background: #0056b3;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0, 123, 255, 0.3);
    }

    .result-print-button:active {
      transform: translateY(0);
    }

    .result-dropdown-content {
      display: none;
      margin-top: 10px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .result-dropdown-content.show {
      display: block;
    }

    .result-all-fields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
    }

    .result-field-complete {
      font-size: 13px;
    }

    .result-field-complete .result-label {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 2px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .result-field-complete .result-value {
      color: var(--muted);
      word-break: break-word;
    }

    .no-results {
      text-align: center;
      padding: 60px 30px;
      color: var(--muted);
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .no-results-icon {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    /* Debug Section Styles */
    .debug-section {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 12px;
      margin-top: 20px;
      overflow: hidden;
    }

    .debug-header {
      background: #e9ecef;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #dee2e6;
    }

    .debug-header h3 {
      margin: 0;
      font-size: 16px;
      color: var(--dark);
    }

    .debug-toggle {
      background: var(--brand);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }

    .debug-toggle:hover {
      background: var(--brand-dark);
    }

    .debug-content {
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .debug-entry {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 12px;
    }

    .debug-timestamp {
      color: var(--muted);
      font-weight: bold;
      margin-bottom: 4px;
    }

    .debug-message {
      color: var(--dark);
      margin-bottom: 6px;
    }

    .debug-data {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 8px;
      white-space: pre-wrap;
      color: #6f42c1;
    }

    .error-message {
      background: var(--error);
      color: var(--white);
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    @media (max-width: 768px) {
      .container { padding: 15px; }
      .header { padding: 20px; }
      .search-section { padding: 20px; }
      .title { font-size: 24px; }
      .search-input { padding: 14px 50px 14px 16px; }
      .search-button { width: 38px; height: 38px; right: 6px; }
      .result-item { padding: 15px 20px; }
      .results-header { padding: 15px 20px; }
      .result-details { grid-template-columns: 1fr; }
      .result-header { flex-direction: column; align-items: flex-start; gap: 10px; }
      .search-examples { justify-content: flex-start; }

      .field-search-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .field-search-actions {
        flex-direction: column;
        align-items: center;
      }

      .search-button-main, .clear-button {
        width: 100%;
        max-width: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="title">Admin Search</div>
      <div class="subtitle">Search client records and uploaded documents</div>
    </div>

    <!-- Exact Quick Search Section -->
    <div class="search-section">
      <h3 style="margin-bottom: 20px; color: var(--dark); font-size: 18px; font-weight: 600;">üéØ Exact Quick Search</h3>

      <div class="search-container">
        <input
          type="text"
          class="search-input"
          id="quickSearchInput"
          placeholder="Search anything: name, case number, phone, SSN, power number..."
          autocomplete="off"
        >
        <button class="search-button" id="quickSearchButton">
          üîç
        </button>
      </div>


      <div class="search-help">
        Universal search - enter any information and we'll search all fields across both databases
      </div>

      <div class="search-examples">
        <span class="example-tag" onclick="setQuickSearchExample('John Smith')">John Smith</span>
        <span class="example-tag" onclick="setQuickSearchExample('561-247-0018')">Phone Number</span>
        <span class="example-tag" onclick="setQuickSearchExample('BC2024001')">Case Number</span>
        <span class="example-tag" onclick="setQuickSearchExample('123-45-6789')">SSN</span>
      </div>
    </div>

    <!-- Advanced Search Section -->
    <div class="search-section advanced-search">
      <div class="advanced-header">
        <h3 style="margin-bottom: 10px; color: var(--muted); font-size: 16px; font-weight: 600;">ü§ñ Advanced Search (AI-Powered)</h3>
        <p style="color: var(--muted); font-size: 14px; margin-bottom: 20px;">Slower but finds similar matches and related results</p>
      </div>

      <div class="search-container">
        <input
          type="text"
          class="search-input"
          id="searchInput"
          placeholder="Enter search terms (e.g., John Smith, Ricardo Perez, 561-555-0123)"
          autocomplete="off"
        >
        <button class="search-button" id="searchButton">
          üîç
        </button>
      </div>

      <div class="search-help">
        Search examples:
      </div>

      <div class="search-examples">
        <span class="example-tag" onclick="setSearchExample('Ricardo Perez')">Ricardo Perez</span>
        <span class="example-tag" onclick="setSearchExample('John Smith 561-555-0123')">Name + Phone</span>
        <span class="example-tag" onclick="setSearchExample('Government ID 2024-01-15')">Document + Date</span>
        <span class="example-tag" onclick="setSearchExample('Jane Doe BC2024001')">Name + Case Number</span>
        <span class="example-tag" onclick="setSearchExample('Smith West Palm Beach')">Name + Location</span>
      </div>

      <!-- Date Range Filter -->
      <div class="date-filter-section">
        <div class="date-filter-title">üìÖ Date Range Filter (Max 1 year span - improves performance)</div>

        <div class="date-row">
          <div class="date-group">
            <div class="date-group-label">From:</div>
            <div class="date-selectors">
              <select id="startYear" class="date-select">
                <option value="">Year</option>
              </select>
              <select id="startMonth" class="date-select">
                <option value="">Month</option>
              </select>
              <select id="startDay" class="date-select">
                <option value="">Day</option>
              </select>
            </div>
          </div>

          <div class="date-group">
            <div class="date-group-label">To:</div>
            <div class="date-selectors">
              <select id="endYear" class="date-select">
                <option value="">Year</option>
              </select>
              <select id="endMonth" class="date-select">
                <option value="">Month</option>
              </select>
              <select id="endDay" class="date-select">
                <option value="">Day</option>
              </select>
            </div>
          </div>
        </div>


        <div class="date-filter-help">
          <strong>Examples:</strong> Select "2024" only = Jan 1, 2024 to now | Select "2024 + March" = March 2024 only<br>
          Partial selections work! Leave end date empty to search from start date to present.
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div class="error-message" id="errorMessage"></div>

    <!-- Loading -->
    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
      <div id="loadingText">Processing search...</div>
      <div id="loadingDetails" style="font-size: 12px; color: var(--muted); margin-top: 10px;">
        Generating embedding for search query and analyzing records
      </div>
    </div>

    <!-- Results Section -->
    <div class="results-section" id="resultsSection">
      <div class="results-header">
        <div>
          <div class="results-count" id="resultsCount">0 results found</div>
          <div class="results-query" id="resultsQuery">No search performed</div>
        </div>
      </div>
      <div class="results-list" id="resultsList"></div>
    </div>

    <!-- No Results -->
    <div class="no-results" id="noResults" style="display: none;">
      <div class="no-results-icon">üîç</div>
      <h3>No results found</h3>
      <p>Try different search terms or check your spelling.<br>
      Use natural language like "John Smith phone number" or "Government ID 2024".</p>
    </div>

    <!-- Debug Information -->
    <div class="debug-section" id="debugSection" style="display: none;">
      <div class="debug-header">
        <h3>üîß Backend Debug Information</h3>
        <button class="debug-toggle" id="debugToggle">Hide Debug</button>
      </div>
      <div class="debug-content" id="debugContent"></div>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      SEARCH_ENDPOINT: 'https://script.google.com/macros/s/AKfycbyKFKAn9MOSjoWIwIHVo_9H66j35-i7P4ry1kLVJfWeqrmHHdmTPrsASMC8Rr4bADwlnw/exec',
      MAX_QUERY_LENGTH: 500,
      DEBOUNCE_DELAY: 300
    };

    // DOM elements
    const searchInput = document.getElementById('searchInput'); // Advanced search
    const searchButton = document.getElementById('searchButton'); // Advanced search
    const quickSearchInput = document.getElementById('quickSearchInput'); // Exact quick search
    const quickSearchButton = document.getElementById('quickSearchButton'); // Exact quick search
    const loading = document.getElementById('loading');
    const resultsSection = document.getElementById('resultsSection');
    const resultsCount = document.getElementById('resultsCount');
    const resultsQuery = document.getElementById('resultsQuery');
    const resultsList = document.getElementById('resultsList');
    const noResults = document.getElementById('noResults');
    const errorMessage = document.getElementById('errorMessage');
    const debugSection = document.getElementById('debugSection');
    const debugContent = document.getElementById('debugContent');
    const debugToggle = document.getElementById('debugToggle');

    let searchTimeout;

    // Event listeners
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    });

    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        if (searchInput.value.trim().length > 2) {
          // Auto-search after user stops typing (optional)
          // performSearch();
        }
      }, CONFIG.DEBOUNCE_DELAY);
    });

    // Advanced search event listeners
    searchButton.addEventListener('click', performSearch);
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    });

    // Exact quick search event listeners
    quickSearchButton.addEventListener('click', performQuickSearch);
    quickSearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performQuickSearch();
      }
    });

    // Debug toggle event listener
    debugToggle.addEventListener('click', () => {
      const content = debugContent;
      const button = debugToggle;

      if (content.style.display === 'none') {
        content.style.display = 'block';
        button.textContent = 'Hide Debug';
      } else {
        content.style.display = 'none';
        button.textContent = 'Show Debug';
      }
    });

    // Set search example - make globally accessible
    window.setSearchExample = function(example) {
      searchInput.value = example;
      searchInput.focus();
    }

    // Set exact quick search example - make globally accessible
    window.setQuickSearchExample = function(example) {
      quickSearchInput.value = example;
      quickSearchInput.focus();
    }


    // Initialize date dropdowns
    function initializeDateDropdowns() {
      const currentYear = new Date().getFullYear();
      const startYear = 2015; // Assuming data starts from 2015

      // Populate year dropdowns
      ['startYear', 'endYear'].forEach(id => {
        const select = document.getElementById(id);
        for (let year = currentYear; year >= startYear; year--) {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          select.appendChild(option);
        }
      });

      // Populate month dropdowns
      const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
      ];

      ['startMonth', 'endMonth'].forEach(id => {
        const select = document.getElementById(id);
        months.forEach((month, index) => {
          const option = document.createElement('option');
          option.value = index + 1;
          option.textContent = month;
          select.appendChild(option);
        });
      });

      // Populate day dropdowns
      ['startDay', 'endDay'].forEach(id => {
        const select = document.getElementById(id);
        for (let day = 1; day <= 31; day++) {
          const option = document.createElement('option');
          option.value = day;
          option.textContent = day;
          select.appendChild(option);
        }
      });

      // Add change listeners for smart date handling
      document.getElementById('startYear').addEventListener('change', updateDateConstraints);
      document.getElementById('startMonth').addEventListener('change', updateDateConstraints);
      document.getElementById('endYear').addEventListener('change', updateDateConstraints);
      document.getElementById('endMonth').addEventListener('change', updateDateConstraints);

      // Auto-fill with today's date to 365 days back
      autoFillDateRange();
    }

    // Auto-fill date range: today to 365 days back
    function autoFillDateRange() {
      const today = new Date();
      const oneYearBack = new Date();
      oneYearBack.setDate(today.getDate() - 365);

      // Set end date to today
      document.getElementById('endYear').value = today.getFullYear();
      document.getElementById('endMonth').value = today.getMonth() + 1; // Months are 0-indexed
      document.getElementById('endDay').value = today.getDate();

      // Set start date to 365 days back
      document.getElementById('startYear').value = oneYearBack.getFullYear();
      document.getElementById('startMonth').value = oneYearBack.getMonth() + 1;
      document.getElementById('startDay').value = oneYearBack.getDate();
    }

    // Update date constraints to enforce 1-year max range
    function updateDateConstraints() {
      const startYear = parseInt(document.getElementById('startYear').value);
      const endYear = parseInt(document.getElementById('endYear').value);

      if (startYear && endYear) {
        if (Math.abs(endYear - startYear) > 1) {
          showError('Date range cannot exceed 1 year. Please adjust your selection.');
          // Reset the problematic selection
          if (endYear > startYear + 1) {
            document.getElementById('endYear').value = '';
          } else if (endYear < startYear - 1) {
            document.getElementById('startYear').value = '';
          }
        }
      }
    }

    // Clear date range - make globally accessible
    window.clearDateRange = function() {
      ['startYear', 'startMonth', 'startDay', 'endYear', 'endMonth', 'endDay'].forEach(id => {
        document.getElementById(id).value = '';
      });
    }

    // Set current year preset - make globally accessible
    window.setCurrentYear = function() {
      window.clearDateRange();
      document.getElementById('startYear').value = new Date().getFullYear();
    }

    // Get date range values with smart partial date handling
    function getDateRange() {
      const startYear = document.getElementById('startYear').value;
      const startMonth = document.getElementById('startMonth').value;
      const startDay = document.getElementById('startDay').value;

      const endYear = document.getElementById('endYear').value;
      const endMonth = document.getElementById('endMonth').value;
      const endDay = document.getElementById('endDay').value;

      if (!startYear && !endYear) {
        return { hasDateFilter: false };
      }

      // Build start date
      let startDate = null;
      if (startYear) {
        const year = parseInt(startYear);
        const month = startMonth ? parseInt(startMonth) - 1 : 0; // January = 0
        const day = startDay ? parseInt(startDay) : 1;
        startDate = new Date(year, month, day).toISOString().split('T')[0];
      }

      // Build end date with smart defaults
      let endDate = null;
      if (endYear) {
        const year = parseInt(endYear);
        const month = endMonth ? parseInt(endMonth) - 1 : 11; // December = 11
        const day = endDay ? parseInt(endDay) : new Date(year, endMonth ? parseInt(endMonth) : 12, 0).getDate(); // Last day of month
        endDate = new Date(year, month, day).toISOString().split('T')[0];
      } else if (startYear && !endYear) {
        // If only start year specified, end date is now
        endDate = new Date().toISOString().split('T')[0];
      }

      // Validate 1-year maximum range
      if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const daysDiff = (end - start) / (1000 * 60 * 60 * 24);

        if (daysDiff > 365) {
          showError(`Date range of ${Math.round(daysDiff)} days exceeds 365 day (1 year) maximum. Please select a shorter range.`);
          return { hasDateFilter: false };
        }

        if (daysDiff < 0) {
          showError('Start date cannot be after end date. Please adjust your selection.');
          return { hasDateFilter: false };
        }
      }

      return {
        startDate: startDate,
        endDate: endDate,
        hasDateFilter: !!(startDate || endDate)
      };
    }

    // Display debug information from backend
    function displayDebugInfo(debugMessages) {
      debugLog('üîß Displaying backend debug info', { messageCount: debugMessages.length });

      debugContent.innerHTML = '';

      debugMessages.forEach((entry, index) => {
        const debugEntry = document.createElement('div');
        debugEntry.className = 'debug-entry';

        const timestamp = document.createElement('div');
        timestamp.className = 'debug-timestamp';
        timestamp.textContent = new Date(entry.timestamp).toLocaleTimeString();

        const message = document.createElement('div');
        message.className = 'debug-message';
        message.textContent = entry.message;

        debugEntry.appendChild(timestamp);
        debugEntry.appendChild(message);

        if (entry.data) {
          const data = document.createElement('div');
          data.className = 'debug-data';
          data.textContent = JSON.stringify(entry.data, null, 2);
          debugEntry.appendChild(data);
        }

        debugContent.appendChild(debugEntry);
      });

      // Show debug section
      debugSection.style.display = 'block';
      debugContent.style.display = 'block';
      debugToggle.textContent = 'Hide Debug';

      debugLog('‚úÖ Debug info displayed successfully');
    }

    // Show error message
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('show');
      setTimeout(() => {
        errorMessage.classList.remove('show');
      }, 5000);
    }

    // Hide all result sections
    function hideAllResults() {
      loading.classList.remove('show');
      resultsSection.classList.remove('show');
      noResults.style.display = 'none';
      debugSection.style.display = 'none';
    }

    // JSONP request function for Google Sites compatibility
    function makeJSONPRequest(url, data) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        const timeoutId = setTimeout(() => {
          cleanup();
          reject(new Error('JSONP request timeout after 3 minutes'));
        }, 180000); // Extended to 3 minutes for OpenAI processing

        function cleanup() {
          clearTimeout(timeoutId);
          const script = document.getElementById(callbackName);
          if (script) {
            document.head.removeChild(script);
          }
          delete window[callbackName];
        }

        window[callbackName] = function(response) {
          cleanup();
          resolve(response);
        };

        const script = document.createElement('script');
        script.id = callbackName;
        script.onerror = () => {
          cleanup();
          reject(new Error('JSONP script load error'));
        };

        // Convert POST data to GET parameters
        const params = new URLSearchParams({
          callback: callbackName,
          query: data.query,
          timestamp: data.timestamp,
          searchType: data.searchType || 'semantic'
        });

        // Add date filter parameters if present
        if (data.dateFilter && data.dateFilter.hasDateFilter) {
          if (data.dateFilter.startDate) {
            params.append('startDate', data.dateFilter.startDate);
          }
          if (data.dateFilter.endDate) {
            params.append('endDate', data.dateFilter.endDate);
          }
        }

        script.src = url + '?' + params.toString();
        document.head.appendChild(script);
      });
    }

    // Debug logging function
    function debugLog(message, data = null) {
      const timestamp = new Date().toISOString();
      const logMessage = `[${timestamp}] ${message}`;
      console.log(logMessage, data || '');

      // Also show debug info in UI for Google Sites debugging
      let debugDiv = document.getElementById('debugInfo');
      if (!debugDiv) {
        debugDiv = createDebugDiv();
      }

      const debugContent = debugDiv.querySelector('.debug-content');
      const debugEntry = document.createElement('div');
      debugEntry.style.fontSize = '12px';
      debugEntry.style.color = '#666';
      debugEntry.style.marginBottom = '5px';
      debugEntry.style.fontFamily = 'monospace';
      debugEntry.textContent = logMessage + (data ? ' | ' + JSON.stringify(data).substring(0, 100) : '');
      debugContent.appendChild(debugEntry);

      // Keep only last 10 debug entries
      while (debugContent.children.length > 10) {
        debugContent.removeChild(debugContent.firstChild);
      }
    }

    function createDebugDiv() {
      const debugDiv = document.createElement('div');
      debugDiv.id = 'debugInfo';
      debugDiv.style.position = 'fixed';
      debugDiv.style.bottom = '10px';
      debugDiv.style.right = '10px';
      debugDiv.style.width = '400px';
      debugDiv.style.maxHeight = '200px';
      debugDiv.style.overflow = 'auto';
      debugDiv.style.background = 'rgba(0,0,0,0.8)';
      debugDiv.style.color = 'white';
      debugDiv.style.padding = '10px';
      debugDiv.style.borderRadius = '5px';
      debugDiv.style.fontSize = '11px';
      debugDiv.style.fontFamily = 'monospace';
      debugDiv.style.zIndex = '9999';

      const title = document.createElement('div');
      title.textContent = 'Debug Log (Click to toggle)';
      title.style.fontWeight = 'bold';
      title.style.marginBottom = '5px';
      title.style.cursor = 'pointer';
      title.onclick = () => {
        const content = debugDiv.querySelector('.debug-content');
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
      };

      // Add copy button
      const copyButton = document.createElement('span');
      copyButton.textContent = ' üìã';
      copyButton.style.cursor = 'pointer';
      copyButton.style.marginLeft = '10px';
      copyButton.style.fontSize = '12px';
      copyButton.title = 'Copy debug log to clipboard';
      copyButton.onclick = (e) => {
        e.stopPropagation(); // Prevent toggle when clicking copy
        copyDebugLog(debugDiv);
      };
      title.appendChild(copyButton);

      const content = document.createElement('div');
      content.className = 'debug-content';
      content.style.cursor = 'pointer';
      content.title = 'Click to copy debug log';
      content.onclick = () => {
        copyDebugLog(debugDiv);
      };

      debugDiv.appendChild(title);
      debugDiv.appendChild(content);
      document.body.appendChild(debugDiv);

      return debugDiv;
    }

    // Copy debug log to clipboard
    function copyDebugLog(debugDiv) {
      try {
        const debugContent = debugDiv.querySelector('.debug-content');
        const debugEntries = Array.from(debugContent.children);
        const debugText = debugEntries.map(entry => entry.textContent).join('\n');

        if (navigator.clipboard && window.isSecureContext) {
          // Use modern clipboard API
          navigator.clipboard.writeText(debugText).then(() => {
            showTemporaryMessage('Debug log copied to clipboard! üìã');
          }).catch(() => {
            fallbackCopyText(debugText);
          });
        } else {
          // Fallback for older browsers
          fallbackCopyText(debugText);
        }
      } catch (error) {
        console.error('Failed to copy debug log:', error);
        showTemporaryMessage('Failed to copy debug log');
      }
    }

    // Fallback copy method
    function fallbackCopyText(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        document.execCommand('copy');
        showTemporaryMessage('Debug log copied to clipboard! üìã');
      } catch (err) {
        showTemporaryMessage('Copy failed - please manually select and copy');
      }

      document.body.removeChild(textArea);
    }

    // Show temporary message
    function showTemporaryMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.textContent = message;
      messageDiv.style.position = 'fixed';
      messageDiv.style.top = '20px';
      messageDiv.style.right = '20px';
      messageDiv.style.background = '#28a745';
      messageDiv.style.color = 'white';
      messageDiv.style.padding = '10px 15px';
      messageDiv.style.borderRadius = '5px';
      messageDiv.style.zIndex = '10000';
      messageDiv.style.fontSize = '14px';
      messageDiv.style.fontWeight = 'bold';

      document.body.appendChild(messageDiv);

      setTimeout(() => {
        if (messageDiv.parentNode) {
          document.body.removeChild(messageDiv);
        }
      }, 2000);
    }

    // Perform search
    async function performSearch() {
      debugLog('üîç Starting search function');

      const query = searchInput.value.trim();
      debugLog('üìù Query input', { query: query, length: query.length });

      if (!query) {
        debugLog('‚ùå Empty query validation failed');
        showError('Please enter search terms');
        return;
      }

      if (query.length > CONFIG.MAX_QUERY_LENGTH) {
        debugLog('‚ùå Query too long validation failed', { length: query.length, max: CONFIG.MAX_QUERY_LENGTH });
        showError(`Search query too long (max ${CONFIG.MAX_QUERY_LENGTH} characters)`);
        return;
      }

      // Check if endpoint is configured
      if (!CONFIG.SEARCH_ENDPOINT || CONFIG.SEARCH_ENDPOINT === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
        debugLog('‚ùå Endpoint not configured');
        showError('Search endpoint not configured. Please set up Google Apps Script Web App URL.');
        return;
      }

      debugLog('üåê Endpoint configured', { endpoint: CONFIG.SEARCH_ENDPOINT });
      debugLog('üè† Current location', {
        protocol: window.location.protocol,
        host: window.location.host,
        origin: window.location.origin,
        href: window.location.href
      });

      // Show loading
      hideAllResults();
      loading.classList.add('show');
      searchButton.disabled = true;
      searchButton.textContent = '‚è≥';
      // Reset the other search button
      quickSearchButton.disabled = false;
      quickSearchButton.textContent = 'üîç';

      const dateRange = getDateRange();

      // Update loading message based on search scope
      const loadingDetails = document.getElementById('loadingDetails');
      if (dateRange.hasDateFilter) {
        loadingDetails.textContent = 'Generating embedding for search query and analyzing filtered records';
      } else {
        loadingDetails.textContent = 'Generating embedding for search query and analyzing all 4,246 records';
      }

      // Don't proceed if date validation failed
      if (dateRange.hasDateFilter === false && (document.getElementById('startYear').value || document.getElementById('endYear').value)) {
        // User tried to set dates but validation failed - reset loading state
        hideAllResults();
        searchButton.disabled = false;
        searchButton.textContent = 'üîç';
        return;
      }

      const requestPayload = {
        query: query,
        searchType: 'semantic', // Explicitly request semantic (AI-powered) search
        timestamp: new Date().toISOString(),
        dateFilter: dateRange
      };

      debugLog('üì§ Preparing request', requestPayload);

      try {
        debugLog('üöÄ About to send fetch request');

        // Test if fetch is available
        if (typeof fetch === 'undefined') {
          throw new Error('Fetch API not available');
        }

        debugLog('‚úÖ Fetch API is available');

        const requestOptions = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestPayload)
        };

        debugLog('üìã Request options', requestOptions);

        let data = null;

        // Safari and Google Sites compatibility: Try JSONP first for more reliable cross-origin requests
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isGoogleSites = window.location.hostname.includes('sites.google.com');

        if (isSafari || isGoogleSites) {
          debugLog('üçé Safari or Google Sites detected - using JSONP for better compatibility');

          try {
            data = await makeJSONPRequest(CONFIG.SEARCH_ENDPOINT, requestPayload);
            debugLog('üì® JSONP response received', { success: data.success, hasResults: !!data.results });
          } catch (jsonpError) {
            debugLog('‚ö†Ô∏è JSONP failed, trying fetch as backup', { error: jsonpError.message });

            try {
              const response = await fetch(CONFIG.SEARCH_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestPayload)
              });

              if (response.ok) {
                data = await response.json();
                debugLog('‚úÖ Backup fetch response received', { success: data.success, hasResults: !!data.results });
              } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
            } catch (fetchError) {
              debugLog('‚ùå Both JSONP and fetch failed', { jsonpError: jsonpError.message, fetchError: fetchError.message });
              throw new Error(`Search failed on Safari/Google Sites. Try:\n1. Refresh the page and try again\n2. Use a more specific search term\n3. Check your internet connection\n\nErrors: JSONP: ${jsonpError.message} | Fetch: ${fetchError.message}`);
            }
          }
        } else {
          // For other browsers, try fetch first then JSONP fallback
          try {
            debugLog('üöÄ Trying fetch request');
            const response = await fetch(CONFIG.SEARCH_ENDPOINT, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(requestPayload)
            });

            if (response.ok) {
              data = await response.json();
              debugLog('‚úÖ Fetch response received', { success: data.success, hasResults: !!data.results });
            } else {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
          } catch (fetchError) {
            debugLog('‚ö†Ô∏è Fetch failed, trying JSONP fallback', { error: fetchError.message });

            try {
              data = await makeJSONPRequest(CONFIG.SEARCH_ENDPOINT, requestPayload);
              debugLog('üì® JSONP response received', { success: data.success, hasResults: !!data.results });
            } catch (jsonpError) {
              debugLog('‚ùå Both fetch and JSONP failed', { fetchError: fetchError.message, jsonpError: jsonpError.message });
              throw new Error(`Search failed. This may indicate:\n1. Network connectivity issues\n2. Server timeout (try a more specific search)\n3. Browser compatibility issue\n\nTry refreshing the page or using a more specific search.\n\nErrors: Fetch: ${fetchError.message} | JSONP: ${jsonpError.message}`);
            }
          }
        }

        debugLog('‚úÖ JSON parsed successfully', {
          success: data.success,
          hasResults: !!data.results,
          resultCount: data.results ? data.results.length : 0,
          hasError: !!data.error,
          hasDebug: !!data.debug
        });

        if (!data.success) {
          debugLog('‚ùå Server returned error response', {
            error: data.error,
            errorName: data.errorName,
            errorMessage: data.errorMessage,
            debug: data.debug
          });

          if (data.debug) {
            debugLog('üîç Server debug info', data.debug);
          }

          if (data.errorStack) {
            debugLog('üìö Server error stack', { stack: data.errorStack });
          }

          throw new Error(data.error || 'Search failed');
        }

        console.log('‚úÖ Search results:', data);
        displayResults(data);

        // Display debug information if available
        if (data.debug && data.debug.length > 0) {
          displayDebugInfo(data.debug);
        }

      } catch (error) {
        debugLog('‚ùå Error caught', {
          name: error.name,
          message: error.message,
          stack: error.stack,
          toString: error.toString()
        });

        console.error('‚ùå Search error:', error);
        showError(`Search failed: ${error.message}`);
        hideAllResults();
      } finally {
        debugLog('üèÅ Search function complete');
        searchButton.disabled = false;
        searchButton.textContent = 'üîç';
      }
    }

    // Display search results
    function displayResults(data) {
      const { results, query, terms } = data;

      hideAllResults();

      // Determine search method used
      let searchMethod = 'Advanced Search (Semantic AI)'; // Default
      if (data.searchType === 'universal' || (results.length > 0 && results[0].overallScore === 1.0)) {
        searchMethod = 'Exact Quick Search (Universal)';
      }

      // Update results header
      resultsCount.textContent = `${results.length} result${results.length === 1 ? '' : 's'} found`;
      resultsQuery.textContent = `Query: "${query}" (${terms.length} search term${terms.length === 1 ? '' : 's'}) ‚Ä¢ ${searchMethod}`;

      if (results.length === 0) {
        noResults.style.display = 'block';
        return;
      }

      // Display results
      resultsList.innerHTML = results.map(result => createResultHTML(result)).join('');
      resultsSection.classList.add('show');
    }

    // Create HTML for a single result
    function createResultHTML(result) {
      const scorePercent = Math.round(result.overallScore * 100);
      const scoreClass = scorePercent >= 80 ? 'success' : scorePercent >= 60 ? 'warning' : 'muted';
      
      // Format timestamp
      const timestamp = result.timestamp ? new Date(result.timestamp).toLocaleDateString() : 'Unknown';
      
      // Create file links
      const fileLinks = result.fileUrls ? result.fileUrls.map((url, index) =>
        `<a href="${url}" target="_blank" class="file-link">File ${index + 1}</a>`
      ).join('') : '';

      return `
        <div class="result-item">
          <div class="result-header">
            <div class="result-client">${escapeHtml(result.clientName)}</div>
            <div class="result-score" style="background: var(--${scoreClass})">${scorePercent}% match</div>
          </div>
          
          <div class="result-details">
            <div class="result-field">
              <div class="result-label">Phone</div>
              <div class="result-value">${escapeHtml(result.phone || 'Not provided')}</div>
            </div>
            <div class="result-field">
              <div class="result-label">Defendant</div>
              <div class="result-value">${escapeHtml(result.defendantName || 'Not provided')}</div>
            </div>
            <div class="result-field">
              <div class="result-label">Case Number</div>
              <div class="result-value">${escapeHtml(result.caseNumber || 'Not provided')}</div>
            </div>
            <div class="result-field">
              <div class="result-label">Date</div>
              <div class="result-value">${timestamp}</div>
            </div>
          </div>
          
          <div class="result-meta">
            <div class="result-source">${escapeHtml(result.documentType)}</div>
            <div class="result-files">
              ${fileLinks || '<span style="color: var(--muted); font-size: 12px;">No files</span>'}
            </div>
          </div>

          <div class="result-actions">
            <button class="result-dropdown-toggle" onclick="toggleResultDropdown(this)">
              <span>View All Fields</span>
              <span class="result-dropdown-icon">‚ñº</span>
            </button>
            <button class="result-print-button" onclick="printResult(${JSON.stringify(result).replace(/"/g, '&quot;')})">
              <span>üñ®Ô∏è Print Record</span>
            </button>
          </div>

          <div class="result-dropdown">
            <div class="result-dropdown-content">
              <div class="result-all-fields">
                ${createAllFieldsHTML(result)}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Create HTML for all available fields in result
    function createAllFieldsHTML(result) {
      if (!result.completeData) {
        return '<div style="color: var(--muted); font-style: italic;">Complete data not available for this result.</div>';
      }

      // Get all fields from completeData, excluding empty ones
      // Keep original Google Sheet column order (no sorting)
      const fields = Object.entries(result.completeData)
        .filter(([key, value]) => value && value.toString().trim() !== '')
        .map(([key, value]) => `
          <div class="result-field-complete">
            <div class="result-label">${escapeHtml(key)}</div>
            <div class="result-value">${escapeHtml(value.toString())}</div>
          </div>
        `);

      if (fields.length === 0) {
        return '<div style="color: var(--muted); font-style: italic;">No additional fields available.</div>';
      }

      return fields.join('');
    }

    // Toggle dropdown visibility
    function toggleResultDropdown(button) {
      const dropdown = button.closest('.result-actions').nextElementSibling;
      const content = dropdown.querySelector('.result-dropdown-content');
      const isExpanded = button.classList.contains('expanded');

      if (isExpanded) {
        button.classList.remove('expanded');
        content.classList.remove('show');
        button.querySelector('span:first-child').textContent = 'View All Fields';
      } else {
        button.classList.add('expanded');
        content.classList.add('show');
        button.querySelector('span:first-child').textContent = 'Hide All Fields';
      }
    }

    // Print individual result - make globally accessible
    window.printResult = function(result) {
      // Create print window
      const printWindow = window.open('', '_blank', 'width=800,height=600');

      // Generate print HTML
      const printHTML = createPrintLayout(result);

      // Write HTML to print window
      printWindow.document.write(printHTML);
      printWindow.document.close();

      // Wait for content to load then print
      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.print();
          // Close window after print dialog closes
          printWindow.onafterprint = function() {
            printWindow.close();
          };
        }, 250);
      };
    }

    // Create print layout HTML
    function createPrintLayout(result) {
      const printDate = new Date().toLocaleString();

      // Get all fields from completeData or use basic fields
      const data = result.completeData || result;

      // Organize fields into sections
      const personalInfo = extractPersonalInfo(data);
      const contactInfo = extractContactInfo(data);
      const caseInfo = extractCaseInfo(data);
      const employmentInfo = extractEmploymentInfo(data);
      const emergencyContacts = extractEmergencyContacts(data);
      const additionalInfo = extractAdditionalInfo(data);

      return `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Client Record - ${escapeHtml(result.clientName || 'Unknown')}</title>
          <style>
            @page {
              size: letter;
              margin: 0.75in;
            }

            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }

            body {
              font-family: 'Arial', 'Helvetica', sans-serif;
              font-size: 11pt;
              line-height: 1.5;
              color: #000;
              background: white;
            }

            .print-header {
              border-bottom: 2px solid #333;
              padding-bottom: 15px;
              margin-bottom: 20px;
            }

            .print-title {
              font-size: 24pt;
              font-weight: bold;
              color: #F28C00;
              margin-bottom: 5px;
            }

            .print-subtitle {
              font-size: 14pt;
              color: #666;
            }

            .print-date {
              font-size: 10pt;
              color: #999;
              text-align: right;
              margin-top: -20px;
            }

            .section {
              margin-bottom: 25px;
              page-break-inside: avoid;
            }

            .section-title {
              font-size: 14pt;
              font-weight: bold;
              color: #333;
              border-bottom: 1px solid #ddd;
              padding-bottom: 5px;
              margin-bottom: 15px;
              background: #f5f5f5;
              padding: 8px;
            }

            .field-grid {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 12px 20px;
            }

            .field-item {
              display: flex;
              min-height: 24px;
              page-break-inside: avoid;
            }

            .field-item.full-width {
              grid-column: 1 / -1;
            }

            .field-label {
              font-weight: bold;
              color: #555;
              min-width: 140px;
              flex-shrink: 0;
              font-size: 10pt;
            }

            .field-value {
              color: #000;
              word-break: break-word;
              font-size: 11pt;
            }

            .field-value.empty {
              color: #999;
              font-style: italic;
            }

            .print-footer {
              margin-top: 40px;
              padding-top: 20px;
              border-top: 1px solid #ddd;
              font-size: 9pt;
              color: #666;
              text-align: center;
            }

            .highlight {
              background-color: #fff3cd;
              padding: 2px 4px;
              font-weight: bold;
            }

            @media print {
              body {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
              }
            }
          </style>
        </head>
        <body>
          <div class="print-header">
            <div class="print-title">Barbie's Bail Bonds</div>
            <div class="print-subtitle">Client Record</div>
            <div class="print-date">Printed: ${printDate}</div>
          </div>

          ${personalInfo.length > 0 ? createPrintSection('Personal Information', personalInfo) : ''}
          ${contactInfo.length > 0 ? createPrintSection('Contact Information', contactInfo) : ''}
          ${caseInfo.length > 0 ? createPrintSection('Case Information', caseInfo) : ''}
          ${employmentInfo.length > 0 ? createPrintSection('Employment Information', employmentInfo) : ''}
          ${emergencyContacts.length > 0 ? createPrintSection('Emergency Contacts', emergencyContacts) : ''}
          ${additionalInfo.length > 0 ? createPrintSection('Additional Information', additionalInfo) : ''}

          <div class="print-footer">
            <p>This document contains confidential information. Handle with appropriate care.</p>
            <p>Barbie's Bail Bonds ‚Ä¢ 561-247-0018 ‚Ä¢ Printed on ${printDate}</p>
          </div>
        </body>
        </html>
      `;
    }

    // Helper function to create print sections
    function createPrintSection(title, fields) {
      if (!fields || fields.length === 0) return '';

      const fieldHTML = fields.map(field => {
        const value = field.value || 'Not provided';
        const isEmpty = !field.value || field.value.toString().trim() === '';
        const fullWidth = field.fullWidth || value.length > 50;

        return `
          <div class="field-item ${fullWidth ? 'full-width' : ''}">
            <span class="field-label">${escapeHtml(field.label)}:</span>
            <span class="field-value ${isEmpty ? 'empty' : ''}">${escapeHtml(value)}</span>
          </div>
        `;
      }).join('');

      return `
        <div class="section">
          <div class="section-title">${title}</div>
          <div class="field-grid">
            ${fieldHTML}
          </div>
        </div>
      `;
    }

    // Extract personal information fields
    function extractPersonalInfo(data) {
      const fields = [];
      const personalFields = [
        { key: "Indemnitor's Complete Name:", label: "Indemnitor Name" },
        { key: "Defendant's Complete Name:", label: "Defendant Name" },
        { key: "Nick Name of Defendant (If not actual name):", label: "Nickname" },
        { key: "Date of Birth:", label: "Date of Birth" },
        { key: "Social Security # (Remember: This is a Secure Form)", label: "SSN" },
        { key: "Driver's License (or ID) #", label: "Driver's License" },
        { key: "Race:", label: "Race" },
        { key: "Citizenship:", label: "Citizenship" },
        { key: "Birth City/State", label: "Birth Location" }
      ];

      personalFields.forEach(field => {
        if (data[field.key]) {
          fields.push({ label: field.label, value: data[field.key] });
        }
      });

      return fields;
    }

    // Extract contact information fields
    function extractContactInfo(data) {
      const fields = [];
      const contactFields = [
        { key: "Cell Phone #", label: "Cell Phone" },
        { key: "Home Phone #", label: "Home Phone" },
        { key: "Email Address:", label: "Email" },
        { key: "Home Address:", label: "Home Address", fullWidth: true },
        { key: "How long have you lived at this address?", label: "Time at Address" }
      ];

      contactFields.forEach(field => {
        if (data[field.key]) {
          fields.push({
            label: field.label,
            value: data[field.key],
            fullWidth: field.fullWidth
          });
        }
      });

      return fields;
    }

    // Extract case information fields
    function extractCaseInfo(data) {
      const fields = [];
      const caseFields = [
        { key: "Booking #", label: "Booking Number" },
        { key: "Case #", label: "Case Number" },
        { key: "Power Number", label: "Power Number" },
        { key: "Timestamp", label: "Entry Date" },
        { key: "Source", label: "Source" },
        { key: "Document Type", label: "Document Type" }
      ];

      // Check both direct properties and nested ones
      caseFields.forEach(field => {
        const value = data[field.key] || data[field.label];
        if (value) {
          fields.push({ label: field.label, value: value });
        }
      });

      // Add basic result fields if available
      if (data.timestamp) fields.push({ label: "Entry Date", value: data.timestamp });
      if (data.caseNumber) fields.push({ label: "Case Number", value: data.caseNumber });
      if (data.documentType) fields.push({ label: "Document Type", value: data.documentType });

      return fields;
    }

    // Extract employment information fields
    function extractEmploymentInfo(data) {
      const fields = [];
      const employmentFields = [
        { key: "Defendant's Employer Name:", label: "Employer" },
        { key: "Defendant's Work Phone #", label: "Work Phone" },
        { key: "Defendant's Work Address", label: "Work Address", fullWidth: true },
        { key: "How long have you been employed at this job?", label: "Employment Duration" },
        { key: "Indemnitor's Employer Name:", label: "Indemnitor's Employer" },
        { key: "Indemnitor's Work Phone #", label: "Indemnitor's Work Phone" }
      ];

      employmentFields.forEach(field => {
        if (data[field.key]) {
          fields.push({
            label: field.label,
            value: data[field.key],
            fullWidth: field.fullWidth
          });
        }
      });

      return fields;
    }

    // Extract emergency contact fields
    function extractEmergencyContacts(data) {
      const fields = [];
      const emergencyFields = [
        { key: "Emergency Contact #1: (REQUIRED)", label: "Emergency Contact 1" },
        { key: "Emergency Contact #2: (REQUIRED)", label: "Emergency Contact 2" },
        { key: "Mother's Name:", label: "Mother's Name" },
        { key: "Mother's Phone #", label: "Mother's Phone" },
        { key: "Father's Name:", label: "Father's Name" },
        { key: "Father's Phone #", label: "Father's Phone" },
        { key: "Sibling 1 Name:", label: "Sibling 1" },
        { key: "Sibling 1 Phone:", label: "Sibling 1 Phone" },
        { key: "Reference 1 Name:", label: "Reference 1" },
        { key: "Reference 1 Phone:", label: "Reference 1 Phone" }
      ];

      emergencyFields.forEach(field => {
        if (data[field.key]) {
          fields.push({ label: field.label, value: data[field.key] });
        }
      });

      return fields;
    }

    // Extract additional information fields not covered in other sections
    function extractAdditionalInfo(data) {
      const fields = [];
      const excludedKeys = [
        "Indemnitor's Complete Name:", "Defendant's Complete Name:", "Nick Name of Defendant",
        "Date of Birth:", "Social Security #", "Driver's License", "Race:", "Citizenship:",
        "Cell Phone #", "Home Phone #", "Email Address:", "Home Address:",
        "Booking #", "Case #", "Power Number", "Timestamp",
        "Defendant's Employer", "Emergency Contact", "Mother's", "Father's", "Sibling",
        "Reference", "Embedding Vector", "rowIndex", "overallScore", "termScores",
        "source", "Source", "clientName", "defendantName", "phone", "nickname",
        "caseNumber", "documentType", "completeData", "fileUrls", "debugFieldMapping"
      ];

      // Add any remaining fields that aren't in the excluded list
      Object.keys(data).forEach(key => {
        const isExcluded = excludedKeys.some(excluded => key.includes(excluded));
        if (!isExcluded && data[key] && data[key].toString().trim()) {
          fields.push({
            label: key.replace(/:/g, ''),
            value: data[key],
            fullWidth: data[key].toString().length > 50
          });
        }
      });

      return fields;
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Perform universal exact quick search
    async function performQuickSearch() {
      debugLog('üîç Starting exact quick search');

      const query = quickSearchInput.value.trim();
      if (!query) {
        showError('Please enter something to search for');
        return;
      }

      debugLog('üìù Exact quick search query', { query });

      // Show loading state
      hideAllResults();
      document.getElementById('resultsList').innerHTML = '<div class="loading">Searching all records...</div>';
      quickSearchButton.disabled = true;
      quickSearchButton.textContent = '‚è≥';
      // Reset the other search button
      searchButton.disabled = false;
      searchButton.textContent = 'üîç';

      try {
        // Get date range
        const dateFilter = getDateRange();

        // Prepare request for universal search
        const requestPayload = {
          query: query,
          searchType: 'universal', // New search type for universal search
          dateFilter: dateFilter
        };

        debugLog('üì§ Exact quick search request', requestPayload);

        // Safari and Google Sites compatibility: Try JSONP first for more reliable cross-origin requests
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isGoogleSites = window.location.hostname.includes('sites.google.com');
        let data;

        if (isSafari || isGoogleSites) {
          debugLog('üçé Safari or Google Sites detected - using JSONP for exact quick search');

          try {
            data = await makeJSONPRequest(CONFIG.SEARCH_ENDPOINT, requestPayload);
            debugLog('üì® JSONP exact quick search response received', { success: data.success, hasResults: !!data.results });
          } catch (jsonpError) {
            debugLog('‚ö†Ô∏è JSONP failed, trying fetch as backup', { error: jsonpError.message });

            try {
              const response = await fetch(CONFIG.SEARCH_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestPayload)
              });

              if (response.ok) {
                data = await response.json();
                debugLog('‚úÖ Backup fetch response received', { success: data.success, hasResults: !!data.results });
              } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
            } catch (fetchError) {
              debugLog('‚ùå Both JSONP and fetch failed', { jsonpError: jsonpError.message, fetchError: fetchError.message });
              throw new Error(`Exact quick search failed on Safari/Google Sites. Try:\n1. Refresh the page and try again\n2. Use a more specific search term\n3. Check your internet connection\n\nErrors: JSONP: ${jsonpError.message} | Fetch: ${fetchError.message}`);
            }
          }
        } else {
          // For other browsers, try fetch first then JSONP fallback
          try {
            debugLog('üöÄ Trying fetch request for exact quick search');
            const response = await fetch(CONFIG.SEARCH_ENDPOINT, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(requestPayload)
            });

            if (response.ok) {
              data = await response.json();
              debugLog('üì® Exact quick search response received', { success: data.success, hasResults: !!data.results });
            } else {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
          } catch (fetchError) {
            debugLog('‚ö†Ô∏è Fetch failed, trying JSONP fallback', { error: fetchError.message });

            try {
              data = await makeJSONPRequest(CONFIG.SEARCH_ENDPOINT, requestPayload);
              debugLog('üì® JSONP response received', { success: data.success, hasResults: !!data.results });
            } catch (jsonpError) {
              debugLog('‚ùå Both fetch and JSONP failed', { fetchError: fetchError.message, jsonpError: jsonpError.message });
              throw new Error(`Exact quick search failed. Try:\n1. Refresh the page and try again\n2. Use a more specific search term\n3. Check your internet connection\n\nErrors: Fetch: ${fetchError.message} | JSONP: ${jsonpError.message}`);
            }
          }
        }

        debugLog('‚úÖ JSON parsed successfully', {
          success: data.success,
          hasResults: !!data.results,
          resultCount: data.results ? data.results.length : 0,
          hasError: !!data.error,
          hasDebug: !!data.debug
        });

        if (!data.success) {
          debugLog('‚ùå Server returned error response', {
            error: data.error,
            errorName: data.errorName,
            errorMessage: data.errorMessage,
            debug: data.debug
          });

          if (data.debug) {
            debugLog('üîç Server debug info', data.debug);
          }

          if (data.errorStack) {
            debugLog('üìö Server error stack', { stack: data.errorStack });
          }

          throw new Error(data.error || 'Exact quick search failed');
        }

        console.log('‚úÖ Exact quick search results:', data);
        displayResults(data);

        // Display debug information if available
        if (data.debug && data.debug.length > 0) {
          displayDebugInfo(data.debug);
        }

      } catch (error) {
        console.error('‚ùå Exact quick search error:', error);
        debugLog('‚ùå Exact quick search failed', { error: error.message, stack: error.stack });

        document.getElementById('resultsList').innerHTML = '';
        showError(`Exact quick search failed: ${error.message}`);
      } finally {
        // Reset button state
        quickSearchButton.disabled = false;
        quickSearchButton.textContent = 'üîç';
      }
    }

    // Detect Safari browser and show compatibility notice
    function checkBrowserCompatibility() {
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

      if (isSafari) {
        console.log('Safari browser detected - CORS improvements applied for both Exact Quick Search and Advanced Search');
        // Safari-specific optimizations are applied in both search functions
        debugLog('ü¶Å Safari compatibility mode enabled');
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      console.log('AdminSearch initialized');
      checkBrowserCompatibility();
      initializeDateDropdowns();
      searchInput.focus();
    });
  </script>

  <!-- Invisible spacer to double page height -->
  <div style="height: 100vh; width: 100%; opacity: 0; pointer-events: none;"></div>
</body>
</html>