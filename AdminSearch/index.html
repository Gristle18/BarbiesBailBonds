<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Search • Barbie's Bail Bonds</title>
  <style>
    :root {
      --brand: #F28C00;
      --brand-dark: #D67700;
      --dark: #111;
      --muted: #666;
      --light-gray: #eee;
      --white: #fff;
      --cream: #fff2d1;
      --black: #000;
      --success: #28a745;
      --error: #dc3545;
      --blue: #007bff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.6;
      color: var(--dark);
      background: var(--light-gray);
      min-height: 100vh;
      overflow-x: hidden; /* Hide horizontal scrollbar */
    }

    /* Hide scrollbars for webkit browsers */
    ::-webkit-scrollbar {
      display: none;
    }

    /* Hide scrollbars for Firefox */
    html {
      scrollbar-width: none;
    }

    /* Remove focus outline and prevent text editing cursor */
    * { outline: none; }
    a, button, .btn { cursor: pointer; }

    .container { 
      width: 100%; 
      max-width: 1400px; 
      margin: 0 auto; 
      padding: 20px; 
    }

    .header { 
      text-align: center; 
      margin-bottom: 30px; 
      background: var(--white);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .title { 
      font-size: 32px; 
      font-weight: 700; 
      margin-bottom: 8px; 
      color: var(--dark);
    }
    
    .subtitle { 
      font-size: 16px; 
      color: var(--muted); 
    }

    .search-section {
      background: var(--white);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .advanced-search {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      margin-top: 20px;
    }

    .advanced-header {
      text-align: center;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 15px;
      margin-bottom: 25px;
    }

    .field-search-container {
      max-width: 900px;
      margin: 0 auto;
    }

    .field-search-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .field-input-group {
      display: flex;
      flex-direction: column;
    }

    .field-input-group label {
      font-size: 14px;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .field-input-group input {
      padding: 12px 16px;
      font-size: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: var(--white);
      color: var(--dark);
      transition: all 0.3s ease;
    }

    .field-input-group input:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(242, 140, 0, 0.1);
      outline: none;
    }

    .field-input-group input::placeholder {
      color: var(--muted);
      font-style: italic;
    }

    .field-search-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 20px;
    }

    .search-button-main {
      background: var(--brand);
      color: var(--white);
      border: none;
      border-radius: 8px;
      padding: 15px 40px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .search-button-main:hover:not(:disabled) {
      background: var(--brand-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(242, 140, 0, 0.3);
    }

    .search-button-main:disabled {
      background: var(--muted);
      cursor: not-allowed;
      transform: none;
    }

    .clear-button {
      background: var(--muted);
      color: var(--white);
      border: none;
      border-radius: 8px;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .clear-button:hover {
      background: var(--dark);
      transform: translateY(-2px);
    }

    .search-container {
      position: relative;
      max-width: 800px;
      margin: 0 auto;
    }

    .search-input {
      width: 100%;
      padding: 16px 60px 16px 20px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 50px;
      background: var(--white);
      color: var(--dark);
      transition: all 0.3s ease;
    }

    .search-input:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(242, 140, 0, 0.1);
    }

    .search-input::placeholder {
      color: var(--muted);
      font-style: italic;
    }

    .search-button {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--brand);
      color: var(--white);
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .search-button:hover:not(:disabled) {
      background: var(--brand-dark);
      transform: translateY(-50%) scale(1.05);
    }

    .search-button:disabled {
      background: var(--muted);
      cursor: not-allowed;
      transform: translateY(-50%);
    }

    .search-help {
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
      color: var(--muted);
    }

    .search-examples {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    .example-tag {
      background: var(--cream);
      color: var(--dark);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .example-tag:hover {
      background: var(--brand);
      color: var(--white);
    }

    .date-filter-section {
      margin-top: 25px;
      padding: 20px;
      background: var(--cream);
      border-radius: 8px;
      border: 1px solid #ddd;
    }

    .date-filter-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 15px;
      text-align: center;
    }

    .date-row {
      display: flex;
      gap: 30px;
      justify-content: center;
      align-items: flex-start;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .date-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      min-width: 200px;
    }

    .date-group-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--dark);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .date-selectors {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .date-select {
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      background: var(--white);
      color: var(--dark);
      transition: all 0.2s ease;
      cursor: pointer;
      min-width: 60px;
    }

    .date-select:focus {
      border-color: var(--brand);
      outline: none;
      box-shadow: 0 0 0 2px rgba(242, 140, 0, 0.1);
    }

    .date-select:hover {
      border-color: var(--brand-dark);
    }

    .date-filter-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 15px;
    }

    .date-clear-btn, .date-preset-btn {
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .date-clear-btn {
      background: var(--muted);
      color: var(--white);
    }

    .date-clear-btn:hover {
      background: var(--dark);
      transform: translateY(-1px);
    }

    .date-preset-btn {
      background: var(--brand);
      color: var(--white);
    }

    .date-preset-btn:hover {
      background: var(--brand-dark);
      transform: translateY(-1px);
    }

    .date-filter-help {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      margin-top: 10px;
      font-style: italic;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--muted);
      display: none;
    }

    .loading.show {
      display: block;
    }

    .loading-spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid var(--light-gray);
      border-top: 3px solid var(--brand);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .results-section {
      display: none;
    }

    .results-section.show {
      display: block;
    }

    .results-header {
      background: var(--white);
      padding: 20px 30px;
      border-radius: 12px 12px 0 0;
      border-bottom: 1px solid var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .results-count {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
    }

    .results-query {
      font-size: 14px;
      color: var(--muted);
      margin-top: 5px;
    }

    .results-list {
      background: var(--white);
      border-radius: 0 0 12px 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .result-item {
      padding: 20px 30px;
      border-bottom: 1px solid var(--light-gray);
      transition: background 0.2s ease;
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-item:hover {
      background: #f8f9fa;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .result-client {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 5px;
    }

    .result-score {
      background: var(--success);
      color: var(--white);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .result-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .result-field {
      display: flex;
      flex-direction: column;
    }

    .result-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 3px;
    }

    .result-value {
      font-size: 14px;
      color: var(--dark);
    }

    .result-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 15px;
      border-top: 1px solid var(--light-gray);
    }

    .result-source {
      font-size: 12px;
      color: var(--muted);
      background: var(--light-gray);
      padding: 4px 8px;
      border-radius: 8px;
    }

    .result-files {
      display: flex;
      gap: 8px;
    }

    .file-link {
      background: var(--blue);
      color: var(--white);
      padding: 6px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .file-link:hover {
      background: #0056b3;
      transform: translateY(-1px);
    }

    .result-dropdown {
      margin-top: 15px;
      border-top: 1px solid var(--light-gray);
      padding-top: 15px;
    }

    .result-dropdown-toggle {
      background: none;
      border: none;
      color: var(--brand);
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 8px 12px;
      border-radius: 6px;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .result-dropdown-toggle:hover {
      background: #f8f9fa;
      color: var(--brand-dark);
    }

    .result-dropdown-icon {
      transition: transform 0.2s ease;
      font-size: 12px;
    }

    .result-dropdown-toggle.expanded .result-dropdown-icon {
      transform: rotate(180deg);
    }

    .result-dropdown-content {
      display: none;
      margin-top: 10px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .result-dropdown-content.show {
      display: block;
    }

    .result-all-fields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
    }

    .result-field-complete {
      font-size: 13px;
    }

    .result-field-complete .result-label {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 2px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .result-field-complete .result-value {
      color: var(--muted);
      word-break: break-word;
    }

    .no-results {
      text-align: center;
      padding: 60px 30px;
      color: var(--muted);
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .no-results-icon {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .error-message {
      background: var(--error);
      color: var(--white);
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    @media (max-width: 768px) {
      .container { padding: 15px; }
      .header { padding: 20px; }
      .search-section { padding: 20px; }
      .title { font-size: 24px; }
      .search-input { padding: 14px 50px 14px 16px; }
      .search-button { width: 38px; height: 38px; right: 6px; }
      .result-item { padding: 15px 20px; }
      .results-header { padding: 15px 20px; }
      .result-details { grid-template-columns: 1fr; }
      .result-header { flex-direction: column; align-items: flex-start; gap: 10px; }
      .search-examples { justify-content: flex-start; }

      .field-search-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .field-search-actions {
        flex-direction: column;
        align-items: center;
      }

      .search-button-main, .clear-button {
        width: 100%;
        max-width: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="title">Admin Search</div>
      <div class="subtitle">Search client records and uploaded documents</div>
    </div>

    <!-- Quick Search Section -->
    <div class="search-section">
      <h3 style="margin-bottom: 20px; color: var(--dark); font-size: 18px; font-weight: 600;">Quick Search</h3>

      <div class="search-container">
        <input
          type="text"
          class="search-input"
          id="quickSearchInput"
          placeholder="Search anything: name, case number, phone, SSN, power number..."
          autocomplete="off"
        >
        <button class="search-button" id="quickSearchButton">
          🔍
        </button>
      </div>


      <div class="search-help">
        Universal search - enter any information and we'll search all fields across both databases
      </div>

      <div class="search-examples">
        <span class="example-tag" onclick="setQuickSearchExample('John Smith')">John Smith</span>
        <span class="example-tag" onclick="setQuickSearchExample('561-247-0018')">Phone Number</span>
        <span class="example-tag" onclick="setQuickSearchExample('BC2024001')">Case Number</span>
        <span class="example-tag" onclick="setQuickSearchExample('123-45-6789')">SSN</span>
      </div>
    </div>

    <!-- Advanced Search Section -->
    <div class="search-section advanced-search">
      <div class="advanced-header">
        <h3 style="margin-bottom: 10px; color: var(--muted); font-size: 16px; font-weight: 600;">🤖 Advanced Search (AI-Powered)</h3>
        <p style="color: var(--muted); font-size: 14px; margin-bottom: 20px;">Slower but finds similar matches and related results</p>
      </div>

      <div class="search-container">
        <input
          type="text"
          class="search-input"
          id="searchInput"
          placeholder="Enter search terms (e.g., John Smith, Ricardo Perez, 561-555-0123)"
          autocomplete="off"
        >
        <button class="search-button" id="searchButton">
          🔍
        </button>
      </div>

      <div class="search-help">
        Search examples:
      </div>

      <div class="search-examples">
        <span class="example-tag" onclick="setSearchExample('Ricardo Perez')">Ricardo Perez</span>
        <span class="example-tag" onclick="setSearchExample('John Smith 561-555-0123')">Name + Phone</span>
        <span class="example-tag" onclick="setSearchExample('Government ID 2024-01-15')">Document + Date</span>
        <span class="example-tag" onclick="setSearchExample('Jane Doe BC2024001')">Name + Case Number</span>
        <span class="example-tag" onclick="setSearchExample('Smith West Palm Beach')">Name + Location</span>
      </div>

      <!-- Date Range Filter -->
      <div class="date-filter-section">
        <div class="date-filter-title">📅 Date Range Filter (Max 1 year span - improves performance)</div>

        <div class="date-row">
          <div class="date-group">
            <div class="date-group-label">From:</div>
            <div class="date-selectors">
              <select id="startYear" class="date-select">
                <option value="">Year</option>
              </select>
              <select id="startMonth" class="date-select">
                <option value="">Month</option>
              </select>
              <select id="startDay" class="date-select">
                <option value="">Day</option>
              </select>
            </div>
          </div>

          <div class="date-group">
            <div class="date-group-label">To:</div>
            <div class="date-selectors">
              <select id="endYear" class="date-select">
                <option value="">Year</option>
              </select>
              <select id="endMonth" class="date-select">
                <option value="">Month</option>
              </select>
              <select id="endDay" class="date-select">
                <option value="">Day</option>
              </select>
            </div>
          </div>
        </div>


        <div class="date-filter-help">
          <strong>Examples:</strong> Select "2024" only = Jan 1, 2024 to now | Select "2024 + March" = March 2024 only<br>
          Partial selections work! Leave end date empty to search from start date to present.
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div class="error-message" id="errorMessage"></div>

    <!-- Loading -->
    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
      <div id="loadingText">Processing search...</div>
      <div id="loadingDetails" style="font-size: 12px; color: var(--muted); margin-top: 10px;">
        Generating embedding for search query and analyzing records
      </div>
    </div>

    <!-- Results Section -->
    <div class="results-section" id="resultsSection">
      <div class="results-header">
        <div>
          <div class="results-count" id="resultsCount">0 results found</div>
          <div class="results-query" id="resultsQuery">No search performed</div>
        </div>
      </div>
      <div class="results-list" id="resultsList"></div>
    </div>

    <!-- No Results -->
    <div class="no-results" id="noResults" style="display: none;">
      <div class="no-results-icon">🔍</div>
      <h3>No results found</h3>
      <p>Try different search terms or check your spelling.<br>
      Use natural language like "John Smith phone number" or "Government ID 2024".</p>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      SEARCH_ENDPOINT: 'https://script.google.com/macros/s/AKfycby4cn36UcBUv7vFfpaym5m1Ogbg0bqkTVkTp1RbMTwHeM3Z6J4r1DWB9TmfzVjido7TtA/exec',
      MAX_QUERY_LENGTH: 500,
      DEBOUNCE_DELAY: 300
    };

    // DOM elements
    const searchInput = document.getElementById('searchInput'); // Advanced search
    const searchButton = document.getElementById('searchButton'); // Advanced search
    const quickSearchInput = document.getElementById('quickSearchInput'); // Quick search
    const quickSearchButton = document.getElementById('quickSearchButton'); // Quick search
    const loading = document.getElementById('loading');
    const resultsSection = document.getElementById('resultsSection');
    const resultsCount = document.getElementById('resultsCount');
    const resultsQuery = document.getElementById('resultsQuery');
    const resultsList = document.getElementById('resultsList');
    const noResults = document.getElementById('noResults');
    const errorMessage = document.getElementById('errorMessage');

    let searchTimeout;

    // Event listeners
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    });

    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        if (searchInput.value.trim().length > 2) {
          // Auto-search after user stops typing (optional)
          // performSearch();
        }
      }, CONFIG.DEBOUNCE_DELAY);
    });

    // Advanced search event listeners
    searchButton.addEventListener('click', performSearch);
    searchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performSearch();
      }
    });

    // Quick search event listeners
    quickSearchButton.addEventListener('click', performQuickSearch);
    quickSearchInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        performQuickSearch();
      }
    });

    // Set search example - make globally accessible
    window.setSearchExample = function(example) {
      searchInput.value = example;
      searchInput.focus();
    }

    // Set quick search example - make globally accessible
    window.setQuickSearchExample = function(example) {
      quickSearchInput.value = example;
      quickSearchInput.focus();
    }


    // Initialize date dropdowns
    function initializeDateDropdowns() {
      const currentYear = new Date().getFullYear();
      const startYear = 2015; // Assuming data starts from 2015

      // Populate year dropdowns
      ['startYear', 'endYear'].forEach(id => {
        const select = document.getElementById(id);
        for (let year = currentYear; year >= startYear; year--) {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year;
          select.appendChild(option);
        }
      });

      // Populate month dropdowns
      const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
      ];

      ['startMonth', 'endMonth'].forEach(id => {
        const select = document.getElementById(id);
        months.forEach((month, index) => {
          const option = document.createElement('option');
          option.value = index + 1;
          option.textContent = month;
          select.appendChild(option);
        });
      });

      // Populate day dropdowns
      ['startDay', 'endDay'].forEach(id => {
        const select = document.getElementById(id);
        for (let day = 1; day <= 31; day++) {
          const option = document.createElement('option');
          option.value = day;
          option.textContent = day;
          select.appendChild(option);
        }
      });

      // Add change listeners for smart date handling
      document.getElementById('startYear').addEventListener('change', updateDateConstraints);
      document.getElementById('startMonth').addEventListener('change', updateDateConstraints);
      document.getElementById('endYear').addEventListener('change', updateDateConstraints);
      document.getElementById('endMonth').addEventListener('change', updateDateConstraints);

      // Auto-fill with today's date to 365 days back
      autoFillDateRange();
    }

    // Auto-fill date range: today to 365 days back
    function autoFillDateRange() {
      const today = new Date();
      const oneYearBack = new Date();
      oneYearBack.setDate(today.getDate() - 365);

      // Set end date to today
      document.getElementById('endYear').value = today.getFullYear();
      document.getElementById('endMonth').value = today.getMonth() + 1; // Months are 0-indexed
      document.getElementById('endDay').value = today.getDate();

      // Set start date to 365 days back
      document.getElementById('startYear').value = oneYearBack.getFullYear();
      document.getElementById('startMonth').value = oneYearBack.getMonth() + 1;
      document.getElementById('startDay').value = oneYearBack.getDate();
    }

    // Update date constraints to enforce 1-year max range
    function updateDateConstraints() {
      const startYear = parseInt(document.getElementById('startYear').value);
      const endYear = parseInt(document.getElementById('endYear').value);

      if (startYear && endYear) {
        if (Math.abs(endYear - startYear) > 1) {
          showError('Date range cannot exceed 1 year. Please adjust your selection.');
          // Reset the problematic selection
          if (endYear > startYear + 1) {
            document.getElementById('endYear').value = '';
          } else if (endYear < startYear - 1) {
            document.getElementById('startYear').value = '';
          }
        }
      }
    }

    // Clear date range - make globally accessible
    window.clearDateRange = function() {
      ['startYear', 'startMonth', 'startDay', 'endYear', 'endMonth', 'endDay'].forEach(id => {
        document.getElementById(id).value = '';
      });
    }

    // Set current year preset - make globally accessible
    window.setCurrentYear = function() {
      window.clearDateRange();
      document.getElementById('startYear').value = new Date().getFullYear();
    }

    // Get date range values with smart partial date handling
    function getDateRange() {
      const startYear = document.getElementById('startYear').value;
      const startMonth = document.getElementById('startMonth').value;
      const startDay = document.getElementById('startDay').value;

      const endYear = document.getElementById('endYear').value;
      const endMonth = document.getElementById('endMonth').value;
      const endDay = document.getElementById('endDay').value;

      if (!startYear && !endYear) {
        return { hasDateFilter: false };
      }

      // Build start date
      let startDate = null;
      if (startYear) {
        const year = parseInt(startYear);
        const month = startMonth ? parseInt(startMonth) - 1 : 0; // January = 0
        const day = startDay ? parseInt(startDay) : 1;
        startDate = new Date(year, month, day).toISOString().split('T')[0];
      }

      // Build end date with smart defaults
      let endDate = null;
      if (endYear) {
        const year = parseInt(endYear);
        const month = endMonth ? parseInt(endMonth) - 1 : 11; // December = 11
        const day = endDay ? parseInt(endDay) : new Date(year, endMonth ? parseInt(endMonth) : 12, 0).getDate(); // Last day of month
        endDate = new Date(year, month, day).toISOString().split('T')[0];
      } else if (startYear && !endYear) {
        // If only start year specified, end date is now
        endDate = new Date().toISOString().split('T')[0];
      }

      // Validate 1-year maximum range
      if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const daysDiff = (end - start) / (1000 * 60 * 60 * 24);

        if (daysDiff > 365) {
          showError(`Date range of ${Math.round(daysDiff)} days exceeds 365 day (1 year) maximum. Please select a shorter range.`);
          return { hasDateFilter: false };
        }

        if (daysDiff < 0) {
          showError('Start date cannot be after end date. Please adjust your selection.');
          return { hasDateFilter: false };
        }
      }

      return {
        startDate: startDate,
        endDate: endDate,
        hasDateFilter: !!(startDate || endDate)
      };
    }

    // Show error message
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.add('show');
      setTimeout(() => {
        errorMessage.classList.remove('show');
      }, 5000);
    }

    // Hide all result sections
    function hideAllResults() {
      loading.classList.remove('show');
      resultsSection.classList.remove('show');
      noResults.style.display = 'none';
    }

    // JSONP request function for Google Sites compatibility
    function makeJSONPRequest(url, data) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        const timeoutId = setTimeout(() => {
          cleanup();
          reject(new Error('JSONP request timeout after 3 minutes'));
        }, 180000); // Extended to 3 minutes for OpenAI processing

        function cleanup() {
          clearTimeout(timeoutId);
          const script = document.getElementById(callbackName);
          if (script) {
            document.head.removeChild(script);
          }
          delete window[callbackName];
        }

        window[callbackName] = function(response) {
          cleanup();
          resolve(response);
        };

        const script = document.createElement('script');
        script.id = callbackName;
        script.onerror = () => {
          cleanup();
          reject(new Error('JSONP script load error'));
        };

        // Convert POST data to GET parameters
        const params = new URLSearchParams({
          callback: callbackName,
          query: data.query,
          timestamp: data.timestamp
        });

        // Add date filter parameters if present
        if (data.dateFilter && data.dateFilter.hasDateFilter) {
          if (data.dateFilter.startDate) {
            params.append('startDate', data.dateFilter.startDate);
          }
          if (data.dateFilter.endDate) {
            params.append('endDate', data.dateFilter.endDate);
          }
        }

        script.src = url + '?' + params.toString();
        document.head.appendChild(script);
      });
    }

    // Debug logging function
    function debugLog(message, data = null) {
      const timestamp = new Date().toISOString();
      const logMessage = `[${timestamp}] ${message}`;
      console.log(logMessage, data || '');

      // Also show debug info in UI for Google Sites debugging
      let debugDiv = document.getElementById('debugInfo');
      if (!debugDiv) {
        debugDiv = createDebugDiv();
      }

      const debugContent = debugDiv.querySelector('.debug-content');
      const debugEntry = document.createElement('div');
      debugEntry.style.fontSize = '12px';
      debugEntry.style.color = '#666';
      debugEntry.style.marginBottom = '5px';
      debugEntry.style.fontFamily = 'monospace';
      debugEntry.textContent = logMessage + (data ? ' | ' + JSON.stringify(data).substring(0, 100) : '');
      debugContent.appendChild(debugEntry);

      // Keep only last 10 debug entries
      while (debugContent.children.length > 10) {
        debugContent.removeChild(debugContent.firstChild);
      }
    }

    function createDebugDiv() {
      const debugDiv = document.createElement('div');
      debugDiv.id = 'debugInfo';
      debugDiv.style.position = 'fixed';
      debugDiv.style.bottom = '10px';
      debugDiv.style.right = '10px';
      debugDiv.style.width = '400px';
      debugDiv.style.maxHeight = '200px';
      debugDiv.style.overflow = 'auto';
      debugDiv.style.background = 'rgba(0,0,0,0.8)';
      debugDiv.style.color = 'white';
      debugDiv.style.padding = '10px';
      debugDiv.style.borderRadius = '5px';
      debugDiv.style.fontSize = '11px';
      debugDiv.style.fontFamily = 'monospace';
      debugDiv.style.zIndex = '9999';

      const title = document.createElement('div');
      title.textContent = 'Debug Log (Click to toggle)';
      title.style.fontWeight = 'bold';
      title.style.marginBottom = '5px';
      title.style.cursor = 'pointer';
      title.onclick = () => {
        const content = debugDiv.querySelector('.debug-content');
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
      };

      // Add copy button
      const copyButton = document.createElement('span');
      copyButton.textContent = ' 📋';
      copyButton.style.cursor = 'pointer';
      copyButton.style.marginLeft = '10px';
      copyButton.style.fontSize = '12px';
      copyButton.title = 'Copy debug log to clipboard';
      copyButton.onclick = (e) => {
        e.stopPropagation(); // Prevent toggle when clicking copy
        copyDebugLog(debugDiv);
      };
      title.appendChild(copyButton);

      const content = document.createElement('div');
      content.className = 'debug-content';
      content.style.cursor = 'pointer';
      content.title = 'Click to copy debug log';
      content.onclick = () => {
        copyDebugLog(debugDiv);
      };

      debugDiv.appendChild(title);
      debugDiv.appendChild(content);
      document.body.appendChild(debugDiv);

      return debugDiv;
    }

    // Copy debug log to clipboard
    function copyDebugLog(debugDiv) {
      try {
        const debugContent = debugDiv.querySelector('.debug-content');
        const debugEntries = Array.from(debugContent.children);
        const debugText = debugEntries.map(entry => entry.textContent).join('\n');

        if (navigator.clipboard && window.isSecureContext) {
          // Use modern clipboard API
          navigator.clipboard.writeText(debugText).then(() => {
            showTemporaryMessage('Debug log copied to clipboard! 📋');
          }).catch(() => {
            fallbackCopyText(debugText);
          });
        } else {
          // Fallback for older browsers
          fallbackCopyText(debugText);
        }
      } catch (error) {
        console.error('Failed to copy debug log:', error);
        showTemporaryMessage('Failed to copy debug log');
      }
    }

    // Fallback copy method
    function fallbackCopyText(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();

      try {
        document.execCommand('copy');
        showTemporaryMessage('Debug log copied to clipboard! 📋');
      } catch (err) {
        showTemporaryMessage('Copy failed - please manually select and copy');
      }

      document.body.removeChild(textArea);
    }

    // Show temporary message
    function showTemporaryMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.textContent = message;
      messageDiv.style.position = 'fixed';
      messageDiv.style.top = '20px';
      messageDiv.style.right = '20px';
      messageDiv.style.background = '#28a745';
      messageDiv.style.color = 'white';
      messageDiv.style.padding = '10px 15px';
      messageDiv.style.borderRadius = '5px';
      messageDiv.style.zIndex = '10000';
      messageDiv.style.fontSize = '14px';
      messageDiv.style.fontWeight = 'bold';

      document.body.appendChild(messageDiv);

      setTimeout(() => {
        if (messageDiv.parentNode) {
          document.body.removeChild(messageDiv);
        }
      }, 2000);
    }

    // Perform search
    async function performSearch() {
      debugLog('🔍 Starting search function');

      const query = searchInput.value.trim();
      debugLog('📝 Query input', { query: query, length: query.length });

      if (!query) {
        debugLog('❌ Empty query validation failed');
        showError('Please enter search terms');
        return;
      }

      if (query.length > CONFIG.MAX_QUERY_LENGTH) {
        debugLog('❌ Query too long validation failed', { length: query.length, max: CONFIG.MAX_QUERY_LENGTH });
        showError(`Search query too long (max ${CONFIG.MAX_QUERY_LENGTH} characters)`);
        return;
      }

      // Check if endpoint is configured
      if (!CONFIG.SEARCH_ENDPOINT || CONFIG.SEARCH_ENDPOINT === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE') {
        debugLog('❌ Endpoint not configured');
        showError('Search endpoint not configured. Please set up Google Apps Script Web App URL.');
        return;
      }

      debugLog('🌐 Endpoint configured', { endpoint: CONFIG.SEARCH_ENDPOINT });
      debugLog('🏠 Current location', {
        protocol: window.location.protocol,
        host: window.location.host,
        origin: window.location.origin,
        href: window.location.href
      });

      // Show loading
      hideAllResults();
      loading.classList.add('show');
      searchButton.disabled = true;
      searchButton.textContent = '⏳';

      const dateRange = getDateRange();

      // Update loading message based on search scope
      const loadingDetails = document.getElementById('loadingDetails');
      if (dateRange.hasDateFilter) {
        loadingDetails.textContent = 'Generating embedding for search query and analyzing filtered records';
      } else {
        loadingDetails.textContent = 'Generating embedding for search query and analyzing all 4,246 records';
      }

      // Don't proceed if date validation failed
      if (dateRange.hasDateFilter === false && (document.getElementById('startYear').value || document.getElementById('endYear').value)) {
        // User tried to set dates but validation failed - reset loading state
        hideAllResults();
        searchButton.disabled = false;
        searchButton.textContent = '🔍';
        return;
      }

      const requestPayload = {
        query: query,
        timestamp: new Date().toISOString(),
        dateFilter: dateRange
      };

      debugLog('📤 Preparing request', requestPayload);

      try {
        debugLog('🚀 About to send fetch request');

        // Test if fetch is available
        if (typeof fetch === 'undefined') {
          throw new Error('Fetch API not available');
        }

        debugLog('✅ Fetch API is available');

        const requestOptions = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestPayload)
        };

        debugLog('📋 Request options', requestOptions);

        let data = null;

        try {
          // Try modern fetch first for better Safari compatibility
          debugLog('🚀 Trying modern fetch request');
          const response = await fetch(CONFIG.SEARCH_ENDPOINT, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestPayload)
          });

          if (response.ok) {
            data = await response.json();
            debugLog('✅ Fetch response received', { success: data.success, hasResults: !!data.results });
          } else {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
        } catch (fetchError) {
          debugLog('⚠️ Fetch failed, trying JSONP fallback', { error: fetchError.message });

          try {
            // Fallback to JSONP for Google Sites compatibility
            debugLog('🔄 Trying JSONP fallback for Google Sites compatibility');
            data = await makeJSONPRequest(CONFIG.SEARCH_ENDPOINT, requestPayload);
            debugLog('📨 JSONP response received', { success: data.success, hasResults: !!data.results });
          } catch (jsonpError) {
            debugLog('❌ Both fetch and JSONP failed', { fetchError: fetchError.message, jsonpError: jsonpError.message });

            // Both methods failed
            throw new Error(`Search failed. This may indicate:\n1. Network connectivity issues\n2. Server timeout (try a more specific search)\n3. Browser compatibility issue\n\nTry using Chrome or Edge browser for best results.\n\nErrors: Fetch: ${fetchError.message} | JSONP: ${jsonpError.message}`);
          }
        }

        debugLog('✅ JSON parsed successfully', {
          success: data.success,
          hasResults: !!data.results,
          resultCount: data.results ? data.results.length : 0,
          hasError: !!data.error,
          hasDebug: !!data.debug
        });

        if (!data.success) {
          debugLog('❌ Server returned error response', {
            error: data.error,
            errorName: data.errorName,
            errorMessage: data.errorMessage,
            debug: data.debug
          });

          if (data.debug) {
            debugLog('🔍 Server debug info', data.debug);
          }

          if (data.errorStack) {
            debugLog('📚 Server error stack', { stack: data.errorStack });
          }

          throw new Error(data.error || 'Search failed');
        }

        console.log('✅ Search results:', data);
        displayResults(data);

      } catch (error) {
        debugLog('❌ Error caught', {
          name: error.name,
          message: error.message,
          stack: error.stack,
          toString: error.toString()
        });

        console.error('❌ Search error:', error);
        showError(`Search failed: ${error.message}`);
        hideAllResults();
      } finally {
        debugLog('🏁 Search function complete');
        searchButton.disabled = false;
        searchButton.textContent = '🔍';
      }
    }

    // Display search results
    function displayResults(data) {
      const { results, query, terms } = data;
      
      hideAllResults();

      // Update results header
      resultsCount.textContent = `${results.length} result${results.length === 1 ? '' : 's'} found`;
      resultsQuery.textContent = `Query: "${query}" (${terms.length} search term${terms.length === 1 ? '' : 's'})`;

      if (results.length === 0) {
        noResults.style.display = 'block';
        return;
      }

      // Display results
      resultsList.innerHTML = results.map(result => createResultHTML(result)).join('');
      resultsSection.classList.add('show');
    }

    // Create HTML for a single result
    function createResultHTML(result) {
      const scorePercent = Math.round(result.overallScore * 100);
      const scoreClass = scorePercent >= 80 ? 'success' : scorePercent >= 60 ? 'warning' : 'muted';
      
      // Format timestamp
      const timestamp = result.timestamp ? new Date(result.timestamp).toLocaleDateString() : 'Unknown';
      
      // Create file links
      const fileLinks = result.fileUrls.map((url, index) => 
        `<a href="${url}" target="_blank" class="file-link">File ${index + 1}</a>`
      ).join('');

      return `
        <div class="result-item">
          <div class="result-header">
            <div class="result-client">${escapeHtml(result.clientName)}</div>
            <div class="result-score" style="background: var(--${scoreClass})">${scorePercent}% match</div>
          </div>
          
          <div class="result-details">
            <div class="result-field">
              <div class="result-label">Phone</div>
              <div class="result-value">${escapeHtml(result.phone || 'Not provided')}</div>
            </div>
            <div class="result-field">
              <div class="result-label">Defendant</div>
              <div class="result-value">${escapeHtml(result.defendantName || 'Not provided')}</div>
            </div>
            <div class="result-field">
              <div class="result-label">Case Number</div>
              <div class="result-value">${escapeHtml(result.caseNumber || 'Not provided')}</div>
            </div>
            <div class="result-field">
              <div class="result-label">Date</div>
              <div class="result-value">${timestamp}</div>
            </div>
          </div>
          
          <div class="result-meta">
            <div class="result-source">${escapeHtml(result.documentType)}</div>
            <div class="result-files">
              ${fileLinks || '<span style="color: var(--muted); font-size: 12px;">No files</span>'}
            </div>
          </div>

          <div class="result-dropdown">
            <button class="result-dropdown-toggle" onclick="toggleResultDropdown(this)">
              <span>View All Fields</span>
              <span class="result-dropdown-icon">▼</span>
            </button>
            <div class="result-dropdown-content">
              <div class="result-all-fields">
                ${createAllFieldsHTML(result)}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Create HTML for all available fields in result
    function createAllFieldsHTML(result) {
      if (!result.completeData) {
        return '<div style="color: var(--muted); font-style: italic;">Complete data not available for this result.</div>';
      }

      // Get all fields from completeData, excluding empty ones
      // Keep original Google Sheet column order (no sorting)
      const fields = Object.entries(result.completeData)
        .filter(([key, value]) => value && value.toString().trim() !== '')
        .map(([key, value]) => `
          <div class="result-field-complete">
            <div class="result-label">${escapeHtml(key)}</div>
            <div class="result-value">${escapeHtml(value.toString())}</div>
          </div>
        `);

      if (fields.length === 0) {
        return '<div style="color: var(--muted); font-style: italic;">No additional fields available.</div>';
      }

      return fields.join('');
    }

    // Toggle dropdown visibility
    function toggleResultDropdown(button) {
      const content = button.nextElementSibling;
      const isExpanded = button.classList.contains('expanded');

      if (isExpanded) {
        button.classList.remove('expanded');
        content.classList.remove('show');
        button.querySelector('span:first-child').textContent = 'View All Fields';
      } else {
        button.classList.add('expanded');
        content.classList.add('show');
        button.querySelector('span:first-child').textContent = 'Hide All Fields';
      }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Perform universal quick search
    async function performQuickSearch() {
      debugLog('🔍 Starting quick search');

      const query = quickSearchInput.value.trim();
      if (!query) {
        showError('Please enter something to search for');
        return;
      }

      debugLog('📝 Quick search query', { query });

      // Show loading state
      hideAllResults();
      document.getElementById('resultsList').innerHTML = '<div class="loading">Searching all records...</div>';

      try {
        // Get date range
        const dateFilter = getDateRange();

        // Prepare request for universal search
        const requestPayload = {
          query: query,
          searchType: 'universal', // New search type for universal search
          dateFilter: dateFilter
        };

        debugLog('📤 Quick search request', requestPayload);

        // Make request to backend
        const response = await fetch(CONFIG.SEARCH_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestPayload),
          mode: 'cors'
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        debugLog('📨 Quick search response', { success: data.success, resultCount: data.results ? data.results.length : 0 });

        if (!data.success) {
          throw new Error(data.error || 'Quick search failed');
        }

        console.log('✅ Quick search results:', data);
        displayResults(data);

      } catch (error) {
        console.error('❌ Quick search error:', error);
        debugLog('❌ Quick search failed', { error: error.message, stack: error.stack });

        document.getElementById('resultsList').innerHTML = '';
        showError(`Quick search failed: ${error.message}`);
      }
    }

    // Detect Safari browser and show compatibility notice
    function checkBrowserCompatibility() {
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

      if (isSafari) {
        console.log('Safari browser detected - CORS improvements applied');
        // Optional: You could show a subtle notice here if needed
        // showError('Safari detected: Enhanced compatibility mode enabled.');
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      console.log('AdminSearch initialized');
      checkBrowserCompatibility();
      initializeDateDropdowns();
      searchInput.focus();
    });
  </script>

  <!-- Invisible spacer to double page height -->
  <div style="height: 100vh; width: 100%; opacity: 0; pointer-events: none;"></div>
</body>
</html>