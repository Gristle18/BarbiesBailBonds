<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAQ ‚Ä¢ Barbie's Bail Bonds</title>
  <style>
    :root {
      --brand: #F28C00;
      --brand-dark: #D67700;
      --dark: #111;
      --muted: #666;
      --light-gray: #eee;
      --white: #fff;
      --cream: #fff2d1;
      --black: #000;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.6;
      color: var(--dark);
      background: var(--white);
      /* Hide scrollbar but keep scrolling functionality */
      overflow: -moz-scrollbars-none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge */
    }

    /* Hide webkit scrollbar */
    body::-webkit-scrollbar {
      width: 0px;
      background: transparent;
    }

    /* Remove focus outline and prevent text editing cursor (restore on interactive) */
    * { outline: none; cursor: default; }
    a, button { cursor: pointer; }

    .container { width: 100%; max-width: 1000px; margin: 0 auto; padding: 40px 20px 60px; }
    .header { text-align: center; margin-bottom: 24px; }
    .title { font-size: 36px; font-weight: 800; margin-bottom: 8px; }
    .subtitle { font-size: 18px; color: var(--muted); }

    .help-banner {
      background: var(--cream);
      color: var(--black);
      padding: 24px;
      border-radius: 12px;
      margin: 24px 0 34px;
      box-shadow: 0 8px 24px rgba(255, 242, 209, 0.2);
      text-align: center;
    }
    .help-banner .phone { font-size: 28px; font-weight: 800; letter-spacing: .5px; }
    .help-banner .phone a { color: var(--brand); text-decoration: none; }
    .help-banner .phone a:hover { color: var(--brand-dark); }

    .faq {
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
      overflow: hidden;
      border: 1px solid #eee;
    }
    .faq-item { border-bottom: 1px solid #eee; }
    .faq-item:last-child { border-bottom: none; }

    .faq-question {
      width: 100%;
      text-align: left;
      padding: 18px 20px;
      background: #fafafa;
      border: none;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .faq-question:hover {
      background: #f0f0f0;
    }
    .faq-question .chevron { transition: transform .2s ease; }
    .faq-item.open .chevron { transform: rotate(90deg); }

    .faq-answer {
      padding: 0 20px 0;
      background: var(--white);
      color: var(--dark);
      overflow: hidden;
      max-height: 0; /* animated expansion */
      transition: max-height 0.3s ease-in-out;
    }
    .faq-answer .answer-inner { padding: 14px 0 18px; }
    .faq-answer p { margin-bottom: 10px; }

    .footer { text-align: center; color: #999; font-size: 14px; margin-top: 30px; }

    /* Search Bar Styles */
    .search-container {
      margin: 24px 0 34px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    
    .search-box {
      width: 100%;
      max-width: 600px;
      position: relative;
    }
    
    .search-input {
      width: 100%;
      padding: 16px 50px 16px 20px;
      border: 2px solid #ddd;
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s ease;
    }
    
    .search-input:focus {
      border-color: var(--brand);
    }
    
    .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      font-size: 20px;
    }
    
    .search-results-info {
      font-size: 14px;
      color: var(--muted);
      text-align: center;
    }
    
    .highlight {
      background: #fff2d1;
      font-weight: 600;
      padding: 1px 3px;
      border-radius: 3px;
    }
    
    .faq-item.hidden {
      display: none;
    }
    
    .no-results {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 16px;
      display: none;
    }

    /* Invisible spacer to double page height */
    .invisible-spacer {
      height: 200vh; /* Double the viewport height */
      width: 100%;
      background: #000000; /* Pure black */
      visibility: visible;
      pointer-events: none;
    }

    /* Chatbot Widget Styles */
    .chat-container {
      position: fixed !important;
      top: 550px !important;
      right: clamp(12px, 3vw, 28px) !important;
      bottom: auto !important;
      left: auto !important;
      transform: none !important;
      z-index: 1000;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* Adjust launcher vertical offset for tablet and phone */
    @media (max-width: 1024px) {
      .chat-container { top: 525px !important; }
    }
    @media (max-width: 600px) {
      .chat-container { top: 500px !important; }
    }

    .chat-button {
      width: clamp(60px, 9vw, 84px);
      height: clamp(60px, 9vw, 84px);
      background: linear-gradient(135deg, #F28C00, #D67700);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: clamp(22px, 4vw, 30px);
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 4px 15px rgba(242, 140, 0, 0.4);
      transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
      animation: pulse 2s infinite;
    }

    .chat-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(242, 140, 0, 0.6);
    }

    .chat-button.active {
      transform: rotate(45deg);
      background: #666;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 4px 15px rgba(242, 140, 0, 0.4); }
      50% { box-shadow: 0 4px 15px rgba(242, 140, 0, 0.8), 0 0 0 10px rgba(242, 140, 0, 0.1); }
    }

    .chat-interface {
      display: none;
      position: absolute;
      bottom: 80px;
      right: 0;
      width: 350px;
      height: 500px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      opacity: 0;
      transform: translateY(20px) scale(0.9);
      transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    .chat-interface.open {
      display: flex;
      flex-direction: column;
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .chat-header {
      background: linear-gradient(135deg, #F28C00, #D67700);
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .chat-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .chat-subtitle {
      font-size: 12px;
      opacity: 0.8;
      margin: 2px 0 0 0;
    }

    .chat-close {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .chat-close:hover {
      background: rgba(255,255,255,0.2);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: #f8f9fa;
      scrollbar-width: thin;
      scrollbar-color: #ddd transparent;
    }

    .chat-messages::-webkit-scrollbar {
      width: 4px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: #ddd;
      border-radius: 2px;
    }

    .chat-input-container {
      padding: 12px 16px;
      background: white;
      border-top: 1px solid #eee;
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      padding: 8px 12px;
      border: 2px solid #eee;
      border-radius: 20px;
      font-size: 14px;
      outline: none;
      resize: none;
      max-height: 80px;
      transition: border-color 0.2s;
    }

    .chat-input:focus {
      border-color: #F28C00;
    }

    .chat-send {
      background: #F28C00;
      color: white;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      font-size: 16px;
    }

    .chat-send:hover:not(:disabled) {
      background: #D67700;
      transform: scale(1.1);
    }

    .chat-send:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .message {
      margin-bottom: 12px;
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-bubble {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .message.assistant .message-bubble {
      background: white;
      color: #333;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .message.user .message-bubble {
      background: linear-gradient(135deg, #F28C00, #D67700);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .message.assistant .message-avatar {
      background: #F28C00;
      color: white;
    }

    .message.user .message-avatar {
      background: #666;
      color: white;
    }

    .welcome-message {
      text-align: center;
      color: #666;
      padding: 30px 20px;
      font-size: 14px;
      line-height: 1.6;
    }

    .typing-indicator {
      display: none;
      padding: 8px 16px;
      color: #666;
      font-size: 12px;
      font-style: italic;
    }

    .typing-dots {
      display: inline-flex;
      gap: 2px;
      margin-left: 4px;
    }

    .typing-dots span {
      width: 4px;
      height: 4px;
      background: #666;
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Mobile Responsive for Chatbot */
    @media (max-width: 600px) {
      .chat-interface {
        height: 400px !important; /* 100px shorter on mobile */
      }
    }
    
    @media (max-width: 480px) {
      .chat-interface {
        width: calc(100vw - 40px);
        height: calc(100vh - 120px);
        bottom: 80px;
        right: -10px;
      }
      
      .chat-container {
        bottom: 20px;
        right: 20px;
      }
    }
  </style>
  
  </head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">Frequently Asked Questions</div>
      <div class="subtitle">Quick answers to common questions about bonds and the release process.</div>
    </div>

    <div class="search-container">
      <div class="search-box">
        <input type="text" class="search-input" id="faqSearch" placeholder="Ask a question or search topics (powered by AI)..." autocomplete="off">
        <span class="search-icon">üîç</span>
      </div>
      <div class="search-results-info" id="searchInfo"></div>
    </div>

    <div class="no-results" id="noResults">
      <p>No questions found matching your search. Try different keywords or browse all questions below.</p>
    </div>

    <!-- Static FAQ container (no API calls needed) -->
    <div class="faq" role="list" id="staticFaqContainer">
      <!-- Static FAQ items will be generated here -->
    </div>
    
    <!-- Dynamic search results container (API calls only when searching) -->
    <div class="faq" role="list" id="dynamicSearchResults" style="display: none;">
      <!-- Dynamic search results will be shown here -->
    </div>

    <div class="footer">
      Copyright ¬© 2024 Barbie's Bail Bonds | Bail Bond Services
    </div>
  </div>

  <script>
    // FAQ Accordion and Search functionality with dynamic generation
    (function () {
      
      // FAQ Data will be fetched from Google Apps Script
      let faqData = [];

      // Fetch FAQ data from Google Apps Script using JSONP to bypass CORS
      function fetchFaqData() {
        console.log('Fetching FAQ data from Google Apps Script using JSONP...');
        return new Promise((resolve) => {
          // Create unique callback name
          const callbackName = 'faqCallback_' + Date.now();
          
          // Create script element
          const script = document.createElement('script');
          script.src = `https://script.google.com/macros/s/AKfycbwIhKuXcceReUGCg7V5xcOi68MGzh1pBAcCpmvK8stOkmyzp5by-4LBWIhkYFh3hz3j/exec?source=FAQ_autoload&format=jsonp&callback=${callbackName}`;
          
          // Set up callback
          window[callbackName] = function(data) {
            console.log('Successfully fetched FAQ data via JSONP:', data);
            // Clean up
            document.head.removeChild(script);
            delete window[callbackName];
            resolve(data);
          };
          
          // Handle errors
          script.onerror = function() {
            console.error('JSONP request failed, using fallback local data');
            // Clean up
            document.head.removeChild(script);
            delete window[callbackName];
            resolve([
              { q: "How do bail bonds work?", a: "Bail bonds allow defendants to be released from custody pending trial, ensuring they appear in court when required." },
              { q: "What is the process for obtaining a bail bond?", a: "You contact a bail bondsman, pay a fee (typically 10% of the bond amount), and provide necessary information." },
              { q: "What information do I need to provide to a bail bondsman?", a: "You'll need the defendant's full name, booking number, and the location of the jail." },
              { q: "How much will I have to pay for a bond?", a: "Using a bondsman, you will typically pay 10% of the bond amount for state charges (15% for federal bonds). For example, if the bond is $5,000, you would pay $500. At the jail, you pay the full bond amount." },
              { q: "Is the premium for the bond refundable?", a: "No, the premium paid to the bondsman is non-refundable once the case is closed or discharged." }
            ]);
          };
          
          // Add timeout
          setTimeout(() => {
            if (window[callbackName]) {
              console.error('JSONP request timeout, using fallback local data');
              document.head.removeChild(script);
              delete window[callbackName];
              resolve([
                { q: "How do bail bonds work?", a: "Bail bonds allow defendants to be released from custody pending trial, ensuring they appear in court when required." },
                { q: "What is the process for obtaining a bail bond?", a: "You contact a bail bondsman, pay a fee (typically 10% of the bond amount), and provide necessary information." },
                { q: "What information do I need to provide to a bail bondsman?", a: "You'll need the defendant's full name, booking number, and the location of the jail." },
                { q: "How much will I have to pay for a bond?", a: "Using a bondsman, you will typically pay 10% of the bond amount for state charges (15% for federal bonds). For example, if the bond is $5,000, you would pay $500. At the jail, you pay the full bond amount." },
                { q: "Is the premium for the bond refundable?", a: "No, the premium paid to the bondsman is non-refundable once the case is closed or discharged." }
              ]);
            }
          }, 10000);
          
          // Add script to head
          document.head.appendChild(script);
        });
      }

      // Function to create a single FAQ item
      function createFaqItem(question, answer, index) {
        return `
          <div class="faq-item" role="listitem">
            <button class="faq-question" aria-expanded="false" aria-controls="faq-panel-${index}">
              <span class="chevron">‚ñ∂</span>
              ${question}
            </button>
            <div class="faq-answer" id="faq-panel-${index}" role="region" aria-hidden="true">
              <div class="answer-inner">
                <p>${answer}</p>
              </div>
            </div>
          </div>
        `;
      }

      // Static FAQ data embedded directly (no API calls!)
      const staticFaqData = [
        { q: "How do bail bonds work?", a: "Bail bonds allow defendants to be released from custody pending trial, ensuring they appear in court when required." },
        { q: "What is the process for obtaining a bail bond?", a: "You contact a bail bondsman, pay a fee (typically 10% of the bond amount), and provide necessary information." },
        { q: "What information do I need to provide to a bail bondsman?", a: "You'll need the defendant's full name, booking number, and the location of the jail." },
        { q: "How much will I have to pay for a bond?", a: "Using a bondsman, you will typically pay 10% of the bond amount for state charges (15% for federal bonds). For example, if the bond is $5,000, you would pay $500. At the jail, you pay the full bond amount." },
        { q: "If a bond is less than $1,000, how much do I have to pay?", a: "In Florida, bonds under $1,000 require a premium of $100. For instance, a $600 bond would have a $100 premium." },
        { q: "Is the premium for the bond refundable?", a: "No, the premium paid to the bondsman is non-refundable once the case is closed or discharged." },
        { q: "Why should I use a bondsman instead of paying the full amount at the jail?", a: "Using a bondsman allows you to pay only a percentage of the bond upfront, freeing up your finances for other legal expenses or obligations." },
        { q: "What is the difference between a defendant and an indemnitor?", a: "A defendant is the person facing criminal charges, while an indemnitor (cosigner) is legally responsible for paying the bond if the defendant fails to appear in court." },
        { q: "How long does it take after I pay the bond for the defendant to get out of jail?", a: "The process typically takes 4 to 6 hours after the bondsman submits the paperwork to the jail." },
        { q: "How will I know when the defendant is out of jail?", a: "The defendant can usually call from the jail once released. You can also check with the jail's inmate records or contact the bondsman for updates." },
        { q: "What happens if I find out that there is a warrant out for my arrest?", a: "Contact the bondsman immediately to arrange a walk-through warrant process at the jail." },
        { q: "How long will I be responsible for the defendant that I bonded out?", a: "You are responsible until the case is closed or discharged by the court." },
        { q: "How long does it take to get my collateral back?", a: "Collateral is returned after the case is closed, typically within 21 days of discharge, provided all conditions are met." },
        { q: "If the defendant is re-arrested, will I still be responsible for the original bond?", a: "Yes, you may be subject to a bond surrender if the defendant is re-arrested while out on bond." },
        { q: "How do bail bondsmen make money?", a: "Bail bondsmen earn a fee (typically 10% of the bond amount) paid by the client. This fee is non-refundable once the defendant is released from custody." },
        { q: "What happens if the defendant misses a court date?", a: "Notify the bondsman immediately. The court may issue a warrant, and the bond may be forfeited." },
        { q: "What if the defendant is not a citizen?", a: "Non-citizens may face immigration holds if arrested, requiring a hearing to determine their status." },
        { q: "How to choose a bail bond company?", a: "Look for companies with good reviews and a solid reputation. Avoid meeting bail agents in unofficial locations." },
        { q: "What happens if you don't pay your bond agent?", a: "Failure to fulfill financial obligations to the bondsman could result in legal action and additional fees." },
        { q: "How can I verify the legitimacy of a bail bonds company?", a: "Verify licenses, check online reviews, and ensure the company operates within legal guidelines." },
        { q: "Are there discounts or payment plans available for bond premiums?", a: "Some bond companies offer payment plans or discounts based on specific circumstances. Inquire with the bondsman for options." },
        { q: "Can a bondsman refuse to bond someone out?", a: "Bondsmen have discretion in deciding whom to bond out based on various factors, including risk assessment and legal requirements." },
        { q: "Can I bail someone out on a weekend or holiday?", a: "Yes, reputable bond companies offer 24/7 availability, including weekends and holidays, for bail services." },
        { q: "What should I do if I can't afford the bond premium?", a: "Discuss payment options with the bondsman. Some may offer flexible payment plans or financing options." },
        { q: "Can a bondsman assist with warrants in other counties?", a: "Yes, bondsmen can often assist with warrants across different counties, coordinating with local authorities for the process." }
      ];

      document.addEventListener('DOMContentLoaded', async () => {
        const staticContainer = document.getElementById('staticFaqContainer');
        const dynamicContainer = document.getElementById('dynamicSearchResults');
        const searchInput = document.getElementById('faqSearch');
        const searchInfo = document.getElementById('searchInfo');
        const noResults = document.getElementById('noResults');

        // Generate static FAQ items (no API call!)
        if (staticContainer) {
          console.log('Generating static FAQ items...');
          staticContainer.innerHTML = staticFaqData.map((item, index) => 
            createFaqItem(item.q, item.a, index)
          ).join('');
          console.log('Static FAQ items generated:', staticFaqData.length);
        } else {
          console.error('Static FAQ container not found!');
        }

        const items = document.querySelectorAll('.faq-item');
        
        // Initialize accordion functionality
        items.forEach((item, idx) => {
          const btn = item.querySelector('.faq-question');
          const panel = item.querySelector('.faq-answer');
          if (!btn || !panel) return;

          btn.addEventListener('click', () => {
            const expanded = btn.getAttribute('aria-expanded') === 'true';
            
            // Close all others (optional: behave like accordion)
            items.forEach(other => {
              const otherBtn = other.querySelector('.faq-question');
              const otherPanel = other.querySelector('.faq-answer');
              if (otherBtn && otherPanel && otherBtn !== btn) {
                otherBtn.setAttribute('aria-expanded', 'false');
                otherPanel.setAttribute('aria-hidden', 'true');
                other.classList.remove('open');
                otherPanel.style.maxHeight = '0';
              }
            });
            
            // Toggle current item
            if (expanded) {
              btn.setAttribute('aria-expanded', 'false');
              panel.setAttribute('aria-hidden', 'true');
              item.classList.remove('open');
              panel.style.maxHeight = '0';
            } else {
              btn.setAttribute('aria-expanded', 'true');
              panel.setAttribute('aria-hidden', 'false');
              item.classList.add('open');
              setTimeout(() => {
                panel.style.maxHeight = panel.scrollHeight + 'px';
              }, 10);
            }
          });
        });

        // Search functionality - ONLY on Enter key or search icon click (no auto-search!)
        const searchIcon = document.querySelector('.search-icon');
        let isSearchActive = false;
        
        function triggerSearch() {
          const query = searchInput.value.trim();
          if (query === '') {
            // Show all static FAQ items
            showStaticFAQs();
            return;
          }
          
          // Hide static FAQs and show dynamic search results
          hideStaticFAQs();
          performSemanticSearch(query);
        }
        
        function showStaticFAQs() {
          isSearchActive = false;
          document.getElementById('staticFaqContainer').style.display = 'block';
          document.getElementById('dynamicSearchResults').style.display = 'none';
          searchInfo.textContent = `Showing ${staticFaqData.length} questions`;
        }
        
        function hideStaticFAQs() {
          isSearchActive = true;
          document.getElementById('staticFaqContainer').style.display = 'none';
          document.getElementById('dynamicSearchResults').style.display = 'block';
          searchInfo.textContent = 'Searching...';
        }
        
        if (searchInput) {
          // Enter key triggers search
          searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              triggerSearch();
            }
          });
        }
        
        if (searchIcon) {
          // Clicking search icon triggers search
          searchIcon.addEventListener('click', function() {
            triggerSearch();
          });
          searchIcon.style.cursor = 'pointer';
        }
        
        updateSearchInfo();

        function performSearch() {
          const searchTerm = searchInput.value.trim();
          const items = document.querySelectorAll('.faq-item');
          
          // If empty search, show all items
          if (searchTerm === '') {
            items.forEach(item => {
              item.classList.remove('hidden');
              const question = item.querySelector('.faq-question span:last-child');
              const answer = item.querySelector('.faq-answer p');
              removeHighlights(question);
              removeHighlights(answer);
            });
            noResults.style.display = 'none';
            updateSearchInfo(items.length, '');
            return;
          }
          
          // Use RAG semantic search for non-empty queries
          console.log('Performing semantic search for:', searchTerm);
          performSemanticSearch(searchTerm);
        }
        
        function performSemanticSearch(query) {
          // Show loading state
          const searchInfo = document.getElementById('searchInfo');
          if (searchInfo) {
            searchInfo.textContent = 'Searching...';
          }
          
          const callbackName = 'searchCallback_' + Date.now();
          const script = document.createElement('script');
          script.src = `https://script.google.com/macros/s/AKfycbwIhKuXcceReUGCg7V5xcOi68MGzh1pBAcCpmvK8stOkmyzp5by-4LBWIhkYFh3hz3j/exec?source=FAQ_search&action=search&query=${encodeURIComponent(query)}&format=jsonp&callback=${callbackName}`;
          
          window[callbackName] = function(results) {
            console.log('Semantic search results:', results);
            
            // Check if we got an error response
            if (results && results.error) {
              console.error('Semantic search API error:', results.error);
              performBasicSearch(query);
              return;
            }
            
            // Check if we got valid results
            if (!results || !results.results || results.results.length === 0) {
              console.log('No semantic results found, falling back to basic search');
              performBasicSearch(query);
              return;
            }
            
            displaySemanticResults(results, query);
            // Clean up
            document.head.removeChild(script);
            delete window[callbackName];
          };
          
          script.onerror = function() {
            console.error('Semantic search failed, falling back to basic search');
            // Clean up
            document.head.removeChild(script);
            delete window[callbackName];
            // Fallback to basic text search
            performBasicSearch(query);
          };
          
          // Add timeout
          setTimeout(() => {
            if (window[callbackName]) {
              console.error('Semantic search timeout, falling back to basic search');
              document.head.removeChild(script);
              delete window[callbackName];
              performBasicSearch(query);
            }
          }, 10000);
          
          document.head.appendChild(script);
        }
        
        function displaySemanticResults(results, query) {
          const dynamicContainer = document.getElementById('dynamicSearchResults');
          const searchInfo = document.getElementById('searchInfo');
          
          let visibleCount = 0;
          
          if (results && results.results && results.results.length > 0) {
            // Create new HTML content for search results
            const searchResultsHTML = results.results.map((result, index) => {
              visibleCount++;
              return createFaqItem(result.question, result.answer, index);
            }).join('');
            
            dynamicContainer.innerHTML = searchResultsHTML;
            
            // Initialize accordion functionality for dynamic results
            const newItems = dynamicContainer.querySelectorAll('.faq-item');
            newItems.forEach(item => {
              const question = item.querySelector('.faq-question');
              const answer = item.querySelector('.faq-answer');
              const panel = answer.querySelector('p');
              
              // Highlight search terms
              highlightText(question.querySelector('span:last-child'), query);
              highlightText(panel, query);
              
              question.addEventListener('click', () => {
                const isOpen = item.classList.contains('open');
                if (isOpen) {
                  item.classList.remove('open');
                  panel.style.maxHeight = null;
                } else {
                  panel.setAttribute('aria-hidden', 'false');
                  item.classList.add('open');
                  setTimeout(() => {
                    panel.style.maxHeight = panel.scrollHeight + 'px';
                  }, 10);
                }
              });
            });
          } else {
            dynamicContainer.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No results found for your search.</p>';
            visibleCount = 0;
          }
          
          // Update search info
          searchInfo.textContent = `Found ${visibleCount} result${visibleCount !== 1 ? 's' : ''} for "${query}"`;
          noResults.style.display = visibleCount === 0 ? 'block' : 'none';
        }
        
        function performBasicSearch(query) {
          const searchTerm = query.toLowerCase();
          const dynamicContainer = document.getElementById('dynamicSearchResults');
          const searchInfo = document.getElementById('searchInfo');
          
          // Search through static FAQ data
          const matchingItems = staticFaqData.filter(item => {
            const questionText = item.q.toLowerCase();
            const answerText = item.a.toLowerCase();
            return questionText.includes(searchTerm) || answerText.includes(searchTerm);
          });
          
          let visibleCount = matchingItems.length;
          
          if (matchingItems.length > 0) {
            // Create HTML for matching items
            const searchResultsHTML = matchingItems.map((item, index) => 
              createFaqItem(item.q, item.a, index)
            ).join('');
            
            dynamicContainer.innerHTML = searchResultsHTML;
            
            // Initialize accordion functionality and highlighting
            const newItems = dynamicContainer.querySelectorAll('.faq-item');
            newItems.forEach(item => {
              const question = item.querySelector('.faq-question');
              const answer = item.querySelector('.faq-answer');
              const panel = answer.querySelector('p');
              
              // Highlight search terms
              highlightText(question.querySelector('span:last-child'), query);
              highlightText(panel, query);
              
              question.addEventListener('click', () => {
                const isOpen = item.classList.contains('open');
                if (isOpen) {
                  item.classList.remove('open');
                  panel.style.maxHeight = null;
                } else {
                  panel.setAttribute('aria-hidden', 'false');
                  item.classList.add('open');
                  setTimeout(() => {
                    panel.style.maxHeight = panel.scrollHeight + 'px';
                  }, 10);
                }
              });
            });
          } else {
            dynamicContainer.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No results found for your search.</p>';
          }
          
          searchInfo.textContent = `Found ${visibleCount} result${visibleCount !== 1 ? 's' : ''} for "${query}" (basic search)`;
          noResults.style.display = visibleCount === 0 ? 'block' : 'none';
        }

        function highlightText(element, searchTerm) {
          if (!element) return;
          const originalText = element.getAttribute('data-original') || element.innerHTML;
          if (!element.getAttribute('data-original')) {
            element.setAttribute('data-original', originalText);
          }
          
          // Simple case-insensitive replacement without regex
          var lowerOriginal = originalText.toLowerCase();
          var lowerSearch = searchTerm.toLowerCase();
          var startIndex = lowerOriginal.indexOf(lowerSearch);
          
          if (startIndex !== -1) {
            var beforeMatch = originalText.substring(0, startIndex);
            var match = originalText.substring(startIndex, startIndex + searchTerm.length);
            var afterMatch = originalText.substring(startIndex + searchTerm.length);
            element.innerHTML = beforeMatch + '<span class="highlight">' + match + '</span>' + afterMatch;
          }
        }

        function removeHighlights(element) {
          if (!element) return;
          const originalText = element.getAttribute('data-original');
          if (originalText) {
            element.innerHTML = originalText;
          }
        }

        function updateSearchInfo(visibleCount = null, searchTerm = '', isSemanticSearch = false, semanticResults = 0) {
          if (!searchInfo) return;
          const totalCount = faqData.length;
          
          if (searchTerm === '') {
            searchInfo.textContent = 'Showing all ' + totalCount + ' questions';
          } else if (visibleCount === 0) {
            searchInfo.textContent = 'No questions found';
          } else if (visibleCount === 1) {
            const prefix = isSemanticSearch ? 'Smart search found ' : '';
            searchInfo.textContent = prefix + '1 question';
          } else {
            const prefix = isSemanticSearch ? 'Smart search found ' : '';
            searchInfo.textContent = prefix + visibleCount + ' questions';
          }
          
          // Add semantic search indicator
          if (isSemanticSearch && visibleCount > 0) {
            searchInfo.textContent += ' (ranked by relevance)';
          }
        }
      });
    })();
  </script>

<!-- Chatbot Widget -->
<div class="chat-container">
  <!-- Floating Chat Button -->
  <button class="chat-button" id="chatButton">
    <span class="chat-icon">üí¨</span>
  </button>
  
  <!-- Expandable Chat Interface -->
  <div class="chat-interface" id="chatInterface">
    <div class="chat-header">
      <div class="chat-title-area">
        <div class="chat-title">AI Assistant</div>
        <div class="chat-subtitle">Ask about bail bonds</div>
      </div>
      <button class="chat-close" id="chatClose">√ó</button>
    </div>
    
    <div class="chat-messages" id="chatMessages">
      <div class="welcome-message">
        üëã Hi! I'm your AI assistant for <strong>Barbie's Bail Bonds</strong>.<br><br>
        Ask me anything about:<br>
        ‚Ä¢ Bail costs & processes<br>
        ‚Ä¢ Court requirements<br>
        ‚Ä¢ Payment options<br>
        ‚Ä¢ Release procedures
      </div>
    </div>
    
    <div class="typing-indicator" id="typingIndicator">
      ü§ñ Assistant is typing
      <div class="typing-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
    
    <div class="chat-input-container">
      <input 
        type="text" 
        class="chat-input" 
        id="chatInput" 
        placeholder="Type your message..."
        maxlength="500"
      >
      <button class="chat-send" id="chatSend">‚ñ∂</button>
    </div>
  </div>
</div>

<script>
(function() {
  // Get DOM elements
  const chatButton = document.getElementById('chatButton');
  const chatInterface = document.getElementById('chatInterface');
  const chatClose = document.getElementById('chatClose');
  const chatMessages = document.getElementById('chatMessages');
  const chatInput = document.getElementById('chatInput');
  const chatSend = document.getElementById('chatSend');
  const typingIndicator = document.getElementById('typingIndicator');

  // (Step 1) Use CSS clamp() on right to adapt to viewport width.
  // No JS-based positioning needed here.

  // Chatbot positioning now handled by CSS position:fixed - no JavaScript needed!

  // Detect if this page is running inside an embed (e.g., Google Sites)
  

  const API_URL = 'https://script.google.com/macros/s/AKfycbwvJ8utZ62xKjZt2nz8wZnBJb5vbOsCD38RJnDZ0yFZGppsfWnmv7_YIuz5yV9lZz7z/exec';
  
  let isOpen = false;
  let conversationHistory = [];
  const MAX_HISTORY = 10; // Keep last 10 exchanges

  // Toggle chat interface
  function toggleChat() {
    isOpen = !isOpen;
    
    if (isOpen) {
      chatInterface.style.display = 'flex';
      // Trigger animation after display change
      setTimeout(() => {
        chatInterface.classList.add('open');
      }, 10);
      chatButton.classList.add('active');
      chatButton.innerHTML = '<span style="transform: rotate(45deg); display: inline-block;">‚úï</span>';
      setTimeout(() => chatInput.focus(), 300);
    } else {
      chatInterface.classList.remove('open');
      chatButton.classList.remove('active');
      chatButton.innerHTML = '<span class="chat-icon">üí¨</span>';
      // Hide after animation completes
      setTimeout(() => {
        if (!isOpen) chatInterface.style.display = 'none';
      }, 300);
    }
  }

  // Event listeners
  chatButton.addEventListener('click', toggleChat);
  chatClose.addEventListener('click', toggleChat);

  // Send message function
  function sendMessage() {
    const message = chatInput.value.trim();
    if (!message || chatSend.disabled) return;

    // Add user message
    addMessage('user', message);
    chatInput.value = '';
    chatSend.disabled = true;
    showTyping();

    // Send to AI backend
    const callbackName = 'chatCallback_' + Date.now();
    const script = document.createElement('script');
    script.src = `${API_URL}?source=FAQ_chatbot&action=chat&query=${encodeURIComponent(message)}&history=${encodeURIComponent(JSON.stringify(conversationHistory))}&format=jsonp&callback=${callbackName}`;

    window[callbackName] = function(response) {
      hideTyping();
      
      let assistantResponse = '';
      if (response && response.answer) {
        assistantResponse = response.answer;
        addMessage('assistant', assistantResponse);
      } else if (response && response.error) {
        assistantResponse = 'I apologize, but I encountered an error. Please try again or call us at 561-247-0018 for immediate assistance.';
        addMessage('assistant', assistantResponse);
        console.error('Chat API error:', response.error);
      } else {
        assistantResponse = 'I apologize, but I couldn\'t generate a response. Please try again or call us at 561-247-0018 for help.';
        addMessage('assistant', assistantResponse);
      }
      
      // Store conversation in history
      conversationHistory.push({
        user: message,
        assistant: assistantResponse
      });
      
      // Keep only last MAX_HISTORY exchanges
      if (conversationHistory.length > MAX_HISTORY) {
        conversationHistory = conversationHistory.slice(-MAX_HISTORY);
      }
      
      // Clean up
      document.head.removeChild(script);
      delete window[callbackName];
    };

    script.onerror = function() {
      hideTyping();
      const errorResponse = 'I\'m having trouble connecting right now. Please try again or call us directly at 561-247-0018 for assistance.';
      addMessage('assistant', errorResponse);
      
      // Store error in conversation history too
      conversationHistory.push({
        user: message,
        assistant: errorResponse
      });
      
      if (conversationHistory.length > MAX_HISTORY) {
        conversationHistory = conversationHistory.slice(-MAX_HISTORY);
      }
      
      document.head.removeChild(script);
      delete window[callbackName];
    };

    // Timeout handler
    setTimeout(() => {
      if (window[callbackName]) {
        hideTyping();
        const timeoutResponse = 'Request timed out. Please call us at 561-247-0018 for immediate assistance.';
        addMessage('assistant', timeoutResponse);
        
        // Store timeout in conversation history too
        conversationHistory.push({
          user: message,
          assistant: timeoutResponse
        });
        
        if (conversationHistory.length > MAX_HISTORY) {
          conversationHistory = conversationHistory.slice(-MAX_HISTORY);
        }
        
        document.head.removeChild(script);
        delete window[callbackName];
      }
    }, 15000);

    document.head.appendChild(script);
  }

  // Add message to chat
  function addMessage(sender, content) {
    // Remove welcome message if it exists
    const welcomeMsg = chatMessages.querySelector('.welcome-message');
    if (welcomeMsg) welcomeMsg.remove();

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.textContent = sender === 'user' ? 'üë§' : 'ü§ñ';
    
    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    
    // Handle line breaks in content
    const paragraphs = content.split('\n').filter(p => p.trim());
    if (paragraphs.length > 1) {
      bubble.innerHTML = paragraphs.map(p => p.trim()).join('<br>');
    } else {
      bubble.textContent = content;
    }
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(bubble);
    chatMessages.appendChild(messageDiv);
    
    // Scroll to bottom
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Show typing indicator
  function showTyping() {
    typingIndicator.style.display = 'block';
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Hide typing indicator
  function hideTyping() {
    typingIndicator.style.display = 'none';
    chatSend.disabled = false;
  }

  // Event listeners for sending messages
  chatSend.addEventListener('click', sendMessage);
  
  chatInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Close chat when clicking outside (optional)
  document.addEventListener('click', function(e) {
    if (isOpen && !chatInterface.contains(e.target) && !chatButton.contains(e.target)) {
      // Uncomment the next line if you want to close chat when clicking outside
      // toggleChat();
    }
  });
  
})();
</script>

<!-- Invisible spacer section to double page height -->
<div class="invisible-spacer"></div>

</body>
</html>

