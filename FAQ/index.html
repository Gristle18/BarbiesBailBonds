<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FAQ ‚Ä¢ Barbie's Bail Bonds</title>
  <style>
    :root {
      --brand: #F28C00;
      --brand-dark: #D67700;
      --dark: #111;
      --muted: #666;
      --light-gray: #eee;
      --white: #fff;
      --cream: #fff2d1;
      --black: #000;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      line-height: 1.6;
      color: var(--dark);
      background: var(--white);
    }

    /* Remove focus outline and prevent text editing cursor (restore on interactive) */
    * { outline: none; cursor: default; }
    a, button { cursor: pointer; }

    .container { width: 100%; max-width: 1000px; margin: 0 auto; padding: 40px 20px 60px; }
    .header { text-align: center; margin-bottom: 24px; }
    .title { font-size: 36px; font-weight: 800; margin-bottom: 8px; }
    .subtitle { font-size: 18px; color: var(--muted); }

    .help-banner {
      background: var(--cream);
      color: var(--black);
      padding: 24px;
      border-radius: 12px;
      margin: 24px 0 34px;
      box-shadow: 0 8px 24px rgba(255, 242, 209, 0.2);
      text-align: center;
    }
    .help-banner .phone { font-size: 28px; font-weight: 800; letter-spacing: .5px; }
    .help-banner .phone a { color: var(--brand); text-decoration: none; }
    .help-banner .phone a:hover { color: var(--brand-dark); }

    .faq {
      background: var(--white);
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
      overflow: hidden;
      border: 1px solid #eee;
    }
    .faq-item { border-bottom: 1px solid #eee; }
    .faq-item:last-child { border-bottom: none; }

    .faq-question {
      width: 100%;
      text-align: left;
      padding: 18px 20px;
      background: #fafafa;
      border: none;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .faq-question:hover {
      background: #f0f0f0;
    }
    .faq-question .chevron { transition: transform .2s ease; }
    .faq-item.open .chevron { transform: rotate(90deg); }

    .faq-answer {
      padding: 0 20px 0;
      background: var(--white);
      color: var(--dark);
      overflow: hidden;
      max-height: 0; /* animated expansion */
      transition: max-height 0.3s ease-in-out;
    }
    .faq-answer .answer-inner { padding: 14px 0 18px; }
    .faq-answer p { margin-bottom: 10px; }

    .footer { text-align: center; color: #999; font-size: 14px; margin-top: 30px; }

    /* Search Bar Styles */
    .search-container {
      margin: 24px 0 34px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    
    .search-box {
      width: 100%;
      max-width: 600px;
      position: relative;
    }
    
    .search-input {
      width: 100%;
      padding: 16px 50px 16px 20px;
      border: 2px solid #ddd;
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s ease;
    }
    
    .search-input:focus {
      border-color: var(--brand);
    }
    
    .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      font-size: 20px;
    }
    
    .search-results-info {
      font-size: 14px;
      color: var(--muted);
      text-align: center;
    }
    
    .highlight {
      background: #fff2d1;
      font-weight: 600;
      padding: 1px 3px;
      border-radius: 3px;
    }
    
    .faq-item.hidden {
      display: none;
    }
    
    .no-results {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 16px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">Frequently Asked Questions</div>
      <div class="subtitle">Quick answers to common questions about bonds and the release process.</div>
    </div>

    <div class="search-container">
      <div class="search-box">
        <input type="text" class="search-input" id="faqSearch" placeholder="Ask a question or search topics (powered by AI)..." autocomplete="off">
        <span class="search-icon">üîç</span>
      </div>
      <div class="search-results-info" id="searchInfo"></div>
    </div>

    <div class="no-results" id="noResults">
      <p>No questions found matching your search. Try different keywords or browse all questions below.</p>
    </div>

    <div class="faq" role="list" id="faqContainer">
      <!-- FAQ items will be dynamically generated here -->
    </div>

    <div class="footer">
      Copyright ¬© 2024 Barbie's Bail Bonds | Bail Bond Services
    </div>
  </div>

  <script>
    // FAQ Accordion and Search functionality with dynamic generation
    (function () {
      
      // FAQ Data will be fetched from Google Apps Script
      let faqData = [];

      // Fetch FAQ data from Google Apps Script using JSONP to bypass CORS
      function fetchFaqData() {
        console.log('Fetching FAQ data from Google Apps Script using JSONP...');
        return new Promise((resolve) => {
          // Create unique callback name
          const callbackName = 'faqCallback_' + Date.now();
          
          // Create script element
          const script = document.createElement('script');
          script.src = `https://script.google.com/macros/s/AKfycbwIhKuXcceReUGCg7V5xcOi68MGzh1pBAcCpmvK8stOkmyzp5by-4LBWIhkYFh3hz3j/exec?format=jsonp&callback=${callbackName}`;
          
          // Set up callback
          window[callbackName] = function(data) {
            console.log('Successfully fetched FAQ data via JSONP:', data);
            // Clean up
            document.head.removeChild(script);
            delete window[callbackName];
            resolve(data);
          };
          
          // Handle errors
          script.onerror = function() {
            console.error('JSONP request failed, using fallback local data');
            // Clean up
            document.head.removeChild(script);
            delete window[callbackName];
            resolve([
              { q: "How do bail bonds work?", a: "Bail bonds allow defendants to be released from custody pending trial, ensuring they appear in court when required." },
              { q: "What is the process for obtaining a bail bond?", a: "You contact a bail bondsman, pay a fee (typically 10% of the bond amount), and provide necessary information." },
              { q: "What information do I need to provide to a bail bondsman?", a: "You'll need the defendant's full name, booking number, and the location of the jail." },
              { q: "How much will I have to pay for a bond?", a: "Using a bondsman, you will typically pay 10% of the bond amount for state charges (15% for federal bonds). For example, if the bond is $5,000, you would pay $500. At the jail, you pay the full bond amount." },
              { q: "Is the premium for the bond refundable?", a: "No, the premium paid to the bondsman is non-refundable once the case is closed or discharged." }
            ]);
          };
          
          // Add timeout
          setTimeout(() => {
            if (window[callbackName]) {
              console.error('JSONP request timeout, using fallback local data');
              document.head.removeChild(script);
              delete window[callbackName];
              resolve([
                { q: "How do bail bonds work?", a: "Bail bonds allow defendants to be released from custody pending trial, ensuring they appear in court when required." },
                { q: "What is the process for obtaining a bail bond?", a: "You contact a bail bondsman, pay a fee (typically 10% of the bond amount), and provide necessary information." },
                { q: "What information do I need to provide to a bail bondsman?", a: "You'll need the defendant's full name, booking number, and the location of the jail." },
                { q: "How much will I have to pay for a bond?", a: "Using a bondsman, you will typically pay 10% of the bond amount for state charges (15% for federal bonds). For example, if the bond is $5,000, you would pay $500. At the jail, you pay the full bond amount." },
                { q: "Is the premium for the bond refundable?", a: "No, the premium paid to the bondsman is non-refundable once the case is closed or discharged." }
              ]);
            }
          }, 10000);
          
          // Add script to head
          document.head.appendChild(script);
        });
      }

      // Function to create a single FAQ item
      function createFaqItem(question, answer, index) {
        return `
          <div class="faq-item" role="listitem">
            <button class="faq-question" aria-expanded="false" aria-controls="faq-panel-${index}">
              <span class="chevron">‚ñ∂</span>
              ${question}
            </button>
            <div class="faq-answer" id="faq-panel-${index}" role="region" aria-hidden="true">
              <div class="answer-inner">
                <p>${answer}</p>
              </div>
            </div>
          </div>
        `;
      }

      document.addEventListener('DOMContentLoaded', async () => {
        const container = document.getElementById('faqContainer');
        const searchInput = document.getElementById('faqSearch');
        const searchInfo = document.getElementById('searchInfo');
        const noResults = document.getElementById('noResults');

        // Fetch FAQ data
        console.log('DOM loaded, starting FAQ initialization...');
        faqData = await fetchFaqData();
        console.log('Final faqData length:', faqData.length);
        
        // Generate all FAQ items
        if (container) {
          console.log('Generating FAQ items...');
          container.innerHTML = faqData.map((item, index) => 
            createFaqItem(item.q, item.a, index)
          ).join('');
          console.log('FAQ items generated, container innerHTML length:', container.innerHTML.length);
        } else {
          console.error('FAQ container not found!');
        }

        const items = document.querySelectorAll('.faq-item');
        
        // Initialize accordion functionality
        items.forEach((item, idx) => {
          const btn = item.querySelector('.faq-question');
          const panel = item.querySelector('.faq-answer');
          if (!btn || !panel) return;

          btn.addEventListener('click', () => {
            const expanded = btn.getAttribute('aria-expanded') === 'true';
            
            // Close all others (optional: behave like accordion)
            items.forEach(other => {
              const otherBtn = other.querySelector('.faq-question');
              const otherPanel = other.querySelector('.faq-answer');
              if (otherBtn && otherPanel && otherBtn !== btn) {
                otherBtn.setAttribute('aria-expanded', 'false');
                otherPanel.setAttribute('aria-hidden', 'true');
                other.classList.remove('open');
                otherPanel.style.maxHeight = '0';
              }
            });
            
            // Toggle current item
            if (expanded) {
              btn.setAttribute('aria-expanded', 'false');
              panel.setAttribute('aria-hidden', 'true');
              item.classList.remove('open');
              panel.style.maxHeight = '0';
            } else {
              btn.setAttribute('aria-expanded', 'true');
              panel.setAttribute('aria-hidden', 'false');
              item.classList.add('open');
              setTimeout(() => {
                panel.style.maxHeight = panel.scrollHeight + 'px';
              }, 10);
            }
          });
        });

        // Search functionality with 3-second debounce
        let searchTimeout;
        if (searchInput) {
          searchInput.addEventListener('input', function() {
            // Clear previous timeout
            clearTimeout(searchTimeout);
            
            // If empty, search immediately to show all items
            if (searchInput.value.trim() === '') {
              performSearch();
              return;
            }
            
            // Set 3-second delay for non-empty searches
            searchTimeout = setTimeout(() => {
              performSearch();
            }, 3000);
          });
          
          // Also allow Enter key for immediate search
          searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              clearTimeout(searchTimeout); // Cancel the timeout
              performSearch();
            }
          });
        }
        
        updateSearchInfo();

        function performSearch() {
          const searchTerm = searchInput.value.trim();
          const items = document.querySelectorAll('.faq-item');
          
          // If empty search, show all items
          if (searchTerm === '') {
            items.forEach(item => {
              item.classList.remove('hidden');
              const question = item.querySelector('.faq-question span:last-child');
              const answer = item.querySelector('.faq-answer p');
              removeHighlights(question);
              removeHighlights(answer);
            });
            noResults.style.display = 'none';
            updateSearchInfo(items.length, '');
            return;
          }
          
          // Use RAG semantic search for non-empty queries
          console.log('Performing semantic search for:', searchTerm);
          performSemanticSearch(searchTerm);
        }
        
        function performSemanticSearch(query) {
          // Show loading state
          const searchInfo = document.getElementById('searchInfo');
          if (searchInfo) {
            searchInfo.textContent = 'Searching...';
          }
          
          const callbackName = 'searchCallback_' + Date.now();
          const script = document.createElement('script');
          script.src = `https://script.google.com/macros/s/AKfycbwIhKuXcceReUGCg7V5xcOi68MGzh1pBAcCpmvK8stOkmyzp5by-4LBWIhkYFh3hz3j/exec?action=search&query=${encodeURIComponent(query)}&format=jsonp&callback=${callbackName}`;
          
          window[callbackName] = function(results) {
            console.log('Semantic search results:', results);
            
            // Check if we got an error response
            if (results && results.error) {
              console.error('Semantic search API error:', results.error);
              performBasicSearch(query);
              return;
            }
            
            // Check if we got valid results
            if (!results || !results.results || results.results.length === 0) {
              console.log('No semantic results found, falling back to basic search');
              performBasicSearch(query);
              return;
            }
            
            displaySemanticResults(results, query);
            // Clean up
            document.head.removeChild(script);
            delete window[callbackName];
          };
          
          script.onerror = function() {
            console.error('Semantic search failed, falling back to basic search');
            // Clean up
            document.head.removeChild(script);
            delete window[callbackName];
            // Fallback to basic text search
            performBasicSearch(query);
          };
          
          // Add timeout
          setTimeout(() => {
            if (window[callbackName]) {
              console.error('Semantic search timeout, falling back to basic search');
              document.head.removeChild(script);
              delete window[callbackName];
              performBasicSearch(query);
            }
          }, 10000);
          
          document.head.appendChild(script);
        }
        
        function displaySemanticResults(results, query) {
          const items = document.querySelectorAll('.faq-item');
          const relevantIds = new Set();
          
          // Get IDs of semantically relevant FAQs
          if (results && results.results && results.results.length > 0) {
            results.results.forEach(result => {
              relevantIds.add(result.id);
            });
          }
          
          let visibleCount = 0;
          
          // Show/hide items based on semantic relevance
          items.forEach((item, index) => {
            if (relevantIds.size > 0 && relevantIds.has(index)) {
              item.classList.remove('hidden');
              visibleCount++;
              
              // Highlight search terms
              const question = item.querySelector('.faq-question span:last-child');
              const answer = item.querySelector('.faq-answer p');
              highlightText(question, query);
              highlightText(answer, query);
            } else {
              item.classList.add('hidden');
              item.classList.remove('open');
              const answerDiv = item.querySelector('.faq-answer');
              if (answerDiv) answerDiv.style.maxHeight = '0';
            }
          });
          
          noResults.style.display = visibleCount === 0 ? 'block' : 'none';
          updateSearchInfo(visibleCount, query, true, results && results.results ? results.results.length : 0);
        }
        
        function performBasicSearch(query) {
          const searchTerm = query.toLowerCase();
          const items = document.querySelectorAll('.faq-item');
          let visibleCount = 0;
          
          items.forEach(item => {
            const question = item.querySelector('.faq-question span:last-child');
            const answer = item.querySelector('.faq-answer p');
            const questionText = question ? question.textContent.toLowerCase() : '';
            const answerText = answer ? answer.textContent.toLowerCase() : '';
            
            if (questionText.includes(searchTerm) || answerText.includes(searchTerm)) {
              item.classList.remove('hidden');
              visibleCount++;
              highlightText(question, query);
              highlightText(answer, query);
            } else {
              item.classList.add('hidden');
              item.classList.remove('open');
              const answerDiv = item.querySelector('.faq-answer');
              if (answerDiv) answerDiv.style.maxHeight = '0';
            }
          });
          
          noResults.style.display = visibleCount === 0 ? 'block' : 'none';
          updateSearchInfo(visibleCount, query, false);
        }

        function highlightText(element, searchTerm) {
          if (!element) return;
          const originalText = element.getAttribute('data-original') || element.innerHTML;
          if (!element.getAttribute('data-original')) {
            element.setAttribute('data-original', originalText);
          }
          
          // Simple case-insensitive replacement without regex
          var lowerOriginal = originalText.toLowerCase();
          var lowerSearch = searchTerm.toLowerCase();
          var startIndex = lowerOriginal.indexOf(lowerSearch);
          
          if (startIndex !== -1) {
            var beforeMatch = originalText.substring(0, startIndex);
            var match = originalText.substring(startIndex, startIndex + searchTerm.length);
            var afterMatch = originalText.substring(startIndex + searchTerm.length);
            element.innerHTML = beforeMatch + '<span class="highlight">' + match + '</span>' + afterMatch;
          }
        }

        function removeHighlights(element) {
          if (!element) return;
          const originalText = element.getAttribute('data-original');
          if (originalText) {
            element.innerHTML = originalText;
          }
        }

        function updateSearchInfo(visibleCount = null, searchTerm = '', isSemanticSearch = false, semanticResults = 0) {
          if (!searchInfo) return;
          const totalCount = faqData.length;
          
          if (searchTerm === '') {
            searchInfo.textContent = 'Showing all ' + totalCount + ' questions';
          } else if (visibleCount === 0) {
            searchInfo.textContent = 'No questions found';
          } else if (visibleCount === 1) {
            const prefix = isSemanticSearch ? 'Smart search found ' : '';
            searchInfo.textContent = prefix + '1 question';
          } else {
            const prefix = isSemanticSearch ? 'Smart search found ' : '';
            searchInfo.textContent = prefix + visibleCount + ' questions';
          }
          
          // Add semantic search indicator
          if (isSemanticSearch && visibleCount > 0) {
            searchInfo.textContent += ' (ranked by relevance)';
          }
        }
      });
    })();
  </script>
</body>
</html>

