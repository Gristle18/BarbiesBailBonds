<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ID & Document Upload ‚Ä¢ Barbie's Bail Bonds - FIXED VERSION</title>
  <script>
    // Add this at the top to replace the upload logic
    
    /**
     * Convert file to base64 string (like bail-bond-application approach)
     */
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          // Get base64 string without the data URL prefix
          const base64 = reader.result.split(',')[1];
          resolve({
            filename: file.name,
            contentType: file.type,
            size: file.size,
            base64: base64
          });
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    /**
     * Fixed submit function that sends JSON with base64 files
     * Based on working bail-bond-application approach
     */
    async function submitUploadFixed(form, suffix) {
      console.log('üöÄ Using FIXED upload method (JSON with base64 like bail-bond-application)');
      
      const successMsg = document.getElementById('successMsg' + suffix);
      const errorMsg = document.getElementById('errorMsg' + suffix);
      const submitBtn = document.getElementById('submitBtn' + suffix);
      
      try {
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = suffix === 'Es' ? 'Enviando...' : 'Submitting...';
        }
        
        // Show progress
        errorMsg.textContent = suffix === 'Es' ? 'Convirtiendo archivos...' : 'Converting files...';
        errorMsg.style.display = 'block';
        errorMsg.style.background = '#2196F3';
        
        // Collect form data as JSON (like bail-bond-application)
        const formData = {
          timestamp: new Date().toISOString(),
          yourName: document.getElementById('yourName' + suffix)?.value || '',
          yourPhone: document.getElementById('yourPhone' + suffix)?.value || '',
          defendantName: document.getElementById('defendantName' + suffix)?.value || '',
          caseNumber: document.getElementById('caseNumber' + suffix)?.value || '',
          language: suffix === 'Es' ? 'spanish' : 'english',
          documentSections: []
        };
        
        console.log('üìã Form data:', formData);
        
        // Process document sections
        const documentSections = form.querySelectorAll('.dynamic-doc-section, .document-section');
        console.log(`üìÅ Found ${documentSections.length} document sections`);
        
        let totalFiles = 0;
        
        for (let index = 0; index < documentSections.length; index++) {
          const section = documentSections[index];
          
          // Get document type
          const docTypeSelect = section.querySelector('select[id*="documentType"]');
          const docType = docTypeSelect ? docTypeSelect.value : 'Other';
          
          console.log(`üìÑ Processing section ${index}: ${docType}`);
          
          const sectionData = {
            documentType: docType,
            files: []
          };
          
          // Find all file inputs in this section
          const fileInputs = section.querySelectorAll('input[type="file"]');
          
          for (const input of fileInputs) {
            if (input.files && input.files.length > 0) {
              for (const file of input.files) {
                console.log(`  üìé Converting ${file.name} to base64...`);
                
                errorMsg.textContent = suffix === 'Es' 
                  ? `Procesando: ${file.name}...`
                  : `Processing: ${file.name}...`;
                
                try {
                  const fileData = await fileToBase64(file);
                  sectionData.files.push(fileData);
                  totalFiles++;
                  console.log(`  ‚úÖ Converted ${file.name} (${(file.size/1024).toFixed(2)} KB)`);
                } catch (err) {
                  console.error(`  ‚ùå Failed to convert ${file.name}:`, err);
                }
              }
            }
          }
          
          if (sectionData.files.length > 0) {
            formData.documentSections.push(sectionData);
          }
        }
        
        console.log(`üìä Total files converted: ${totalFiles}`);
        
        if (totalFiles === 0) {
          throw new Error(suffix === 'Es' 
            ? 'No se encontraron archivos para cargar'
            : 'No files found to upload');
        }
        
        // Update progress
        errorMsg.textContent = suffix === 'Es' 
          ? 'Enviando al servidor...'
          : 'Sending to server...';
        
        // Google Apps Script URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw9DvZFje5f_ssDVNh7eXaARwbK0VdCCzJct6iw22K10PRJMVkGnhVHjVBv3dvfmqvk/exec';
        
        console.log('üì§ Sending JSON data to Google Apps Script (like bail-bond-application)...');
        console.log('üì¶ Payload size:', JSON.stringify(formData).length, 'characters');
        
        // Send as JSON exactly like bail-bond-application does
        const response = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors', // Same as bail-bond-application
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });
        
        // With no-cors, we can't read response (same as bail-bond-application)
        console.log('‚úÖ Upload request sent successfully (no-cors mode)');
        
        // Show success
        errorMsg.style.display = 'none';
        successMsg.style.display = 'block';
        successMsg.textContent = suffix === 'Es'
          ? '¬°Documentos enviados exitosamente!'
          : 'Documents uploaded successfully!';
        
        // Reset form
        form.reset();
        form.querySelectorAll('.file-list').forEach(el => el.textContent = '');
        
        // Clear any dynamic sections
        const dynamicContainer = document.getElementById('dynamicDocumentSections' + suffix);
        if (dynamicContainer) {
          dynamicContainer.innerHTML = '';
        }
        
      } catch (error) {
        console.error('‚ùå Upload error:', error);
        
        errorMsg.style.display = 'block';
        errorMsg.style.background = '';
        errorMsg.textContent = suffix === 'Es'
          ? `Error: ${error.message}. Por favor env√≠e sus fotos por texto a 561-247-0018.`
          : `Error: ${error.message}. Please text your photos to 561-247-0018.`;
        
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = suffix === 'Es' ? 'Enviar Documentos' : 'Submit Documents';
        }
      }
    }
    
    // This will override the existing form submission
    window.addEventListener('DOMContentLoaded', function() {
      console.log('üîß Installing FIXED upload handler...');
      
      // Replace submit handlers for both forms
      ['En', 'Es'].forEach(suffix => {
        const form = document.getElementById('uploadForm' + suffix);
        if (form) {
          // Remove all existing submit handlers
          const newForm = form.cloneNode(true);
          form.parentNode.replaceChild(newForm, form);
          
          // Add our fixed handler
          newForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log(`üìù FIXED handler triggered for ${suffix === 'Es' ? 'Spanish' : 'English'} form`);
            await submitUploadFixed(newForm, suffix);
          });
          
          console.log(`‚úÖ FIXED handler installed for ${suffix === 'Es' ? 'Spanish' : 'English'} form`);
        }
      });
    });
  </script>
</head>
<body>
  <h1>This is a FIXED version of index.html</h1>
  <p>Copy the script section above into your actual index.html file, replacing the existing upload logic.</p>
  <p>This version converts files to base64 and sends as JSON, exactly like the working bail-bond-application.</p>
</body>
</html>